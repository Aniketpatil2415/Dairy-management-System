<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
    </script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* Dark Mode styles */
        body.dark { background-color: #111827; }
        body.dark .chat-bubble-bot { background-color: #374151; color: #f3f4f6; }
        body.dark .chat-bubble-user { background-color: #1d4ed8; color: #f3f4f6; }
        body.dark #chat-container { background-color: #1f2937; border-color: #374151; }
        body.dark #user-input { background-color: #374151; border-color: #4b5563; color: #f3f4f6; }
        body.dark #user-input::placeholder { color: #6b7280; }
        body.dark #send-btn { background-color: #3b82f6; }
        body.dark #send-btn:hover { background-color: #2563eb; }
    </style>
</head>
<body class="antialiased bg-gray-100">

    <div class="flex flex-col items-center justify-center min-h-screen p-4">
        
        <div class="w-full max-w-2xl flex justify-between items-center mb-4">
            <a href="index.html" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">
                <i class="fas fa-arrow-left mr-1"></i> Back to Admin
            </a>
            <button id="theme-toggle" class="py-1 px-3 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-semibold rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                <i id="theme-icon-sun" class="fas fa-sun hidden text-yellow-500"></i>
                <i id="theme-icon-moon" class="fas fa-moon text-yellow-500"></i>
            </button>
        </div>

        <div id="chat-container" class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden flex flex-col" style="height: 75vh;">
            
            <div class="p-4 border-b dark:border-gray-700">
                <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Dairy Support Chatbot</h1>
                <p class="text-sm text-gray-600 dark:text-gray-400">Ask me questions about the app.</p>
            </div>

            <div id="chat-box" class="flex-1 p-4 overflow-y-auto space-y-4">
                <div class="chat-bubble-bot w-fit max-w-xs md:max-w-md bg-gray-200 text-gray-800 p-3 rounded-lg">
                    Hello! I am your Dairy App assistant. How can I help you today?
                </div>
            </div>

            <div class="p-4 border-t dark:border-gray-700 flex items-center space-x-2">
                <input type="text" id="user-input" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Type your question here...">
                <button id="send-btn" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Google AI SDK
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // -----------------------------------------------------------------
        // ⚠️ WARNING: DO NOT USE THIS IN PRODUCTION.
        // Your API key is visible to everyone. Use a serverless function.
        // This key is from your main file.
        const GEMINI_API_KEY = "AIzaSyBzrprprCI-bInBXLtFCNZ5vh-14cCV0HZM";
        // -----------------------------------------------------------------

        // --- 1. YOUR "WEBSITE DATA" (Knowledge Base) ---
        // Yahaan aap apne app ke baare mein info daalo
        const WEBSITE_DATA = [
            "How to add a new customer: To add a new customer, go to the 'Customers' page and fill out the 'Add New Customer' form. You need to enter their name, phone, address, default milk quantity, milk type (cow or buffalo), and shift (morning or evening).",
            "How to add daily milk log: Go to the 'Daily Log' page. Check the box next to each customer who received milk. You can change the quantity if needed. When finished, click the 'Save Today's Log' button at the bottom.",
            "How to check customer balance: You can see the balance for all customers on the 'Customers' page. To see detailed history, click on a customer's name to open the 'Customer History' modal.",
            "What is the Fat Log page for: The 'Fat Log' page is used to record the daily fat percentage of the collected milk. This is shown on the Dashboard chart.",
            "How to change milk price: To set or change the price for cow milk and buffalo milk, go to the 'Settings' page and enter the new rates, then click 'Save Settings'.",
            "How to receive payment from a customer: On the 'Customers' page, find the customer in the list. Click the green button with the receipt icon. A modal will pop up where you can enter the amount received and click 'Add Payment'.",
            "How to see monthly expenses: Go to the 'Expenses' page. You can add new expenses and see a list of all past expenses. You can also click the 'Get Monthly Expense Summary' button to get an AI-powered summary."
        ];
        // ---------------------------------------------------

        // SDK Initialization
        let genAI;
        let embeddingModel;
        let generativeModel;
        let dataEmbeddings = [];

        // DOM Elements
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        // --- 2. RAG Helper Functions ---

        // Calculate Dot Product (for vector similarity)
        function dotProduct(a, b) {
            let sum = 0;
            for (let i = 0; i < a.length; i++) {
                sum += (a[i] * b[i]);
            }
            return sum;
        }

        // Add a message to the chat UI
        function addMessage(message, sender) {
            const bubble = document.createElement('div');
            bubble.textContent = message;
            if (sender === 'user') {
                bubble.className = 'chat-bubble-user w-fit max-w-xs md:max-w-md bg-blue-600 text-white p-3 rounded-lg self-end';
            } else {
                bubble.className = 'chat-bubble-bot w-fit max-w-xs md:max-w-md bg-gray-200 text-gray-800 p-3 rounded-lg';
            }
            // Add dark mode classes if needed
            if (document.body.classList.contains('dark')) {
                if (sender === 'user') {
                    bubble.classList.add('dark:bg-blue-600', 'dark:text-white');
                } else {
                    bubble.classList.add('dark:bg-gray-700', 'dark:text-gray-100');
                }
            }
            chatBox.appendChild(bubble);
            chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll
        }
        
        // Show loading indicator
        function showLoading() {
            const loadingBubble = document.createElement('div');
            loadingBubble.id = 'loading-bubble';
            loadingBubble.className = 'chat-bubble-bot w-fit bg-gray-200 dark:bg-gray-700 p-3 rounded-lg';
            loadingBubble.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            chatBox.appendChild(loadingBubble);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        // Hide loading indicator
        function hideLoading() {
            const loadingBubble = document.getElementById('loading-bubble');
            if (loadingBubble) {
                loadingBubble.remove();
            }
        }

        // --- 3. Main RAG Logic ---

        // Initialize models and create embeddings for our data
        async function initializeApp() {
            try {
                genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
                embeddingModel = genAI.getGenerativeModel({ model: "text-embedding-004" });
                generativeModel = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                addMessage("I am setting up my knowledge base...", 'bot');

                // Embed all website data
                const embedRequests = WEBSITE_DATA.map(text => {
                    return embeddingModel.embedContent({
                        content: text,
                        taskType: "RETRIEVAL_DOCUMENT"
                    });
                });
                
                const results = await Promise.all(embedRequests);
                
                dataEmbeddings = results.map((result, i) => ({
                    text: WEBSITE_DATA[i],
                    embedding: result.embedding
                }));

                hideLoading();
                addMessage("I'm ready! Ask me anything about the app.", 'bot');
                
            } catch (error) {
                console.error("Initialization Error:", error);
                hideLoading();
                addMessage("Sorry, I couldn't initialize my brain. My API key might be invalid or restricted. Please check the console.", 'bot');
            }
        }

        // Find relevant data from our knowledge base
        async function findRelevantContext(query) {
            try {
                // 1. Embed the user's query
                const queryEmbedding = await embeddingModel.embedContent({
                    content: query,
                    taskType: "RETRIEVAL_QUERY"
                });

                // 2. Compare query embedding with data embeddings
                const similarities = dataEmbeddings.map((doc, i) => ({
                    index: i,
                    text: doc.text,
                    similarity: dotProduct(queryEmbedding.embedding, doc.embedding)
                }));

                // 3. Sort by similarity (highest first)
                similarities.sort((a, b) => b.similarity - a.similarity);

                // 4. Get top 2 most relevant contexts
                const topContexts = similarities.slice(0, 2).map(item => item.text);
                return topContexts.join("\n\n"); // Join contexts

            } catch (error) {
                console.error("Context finding error:", error);
                return ""; // Return empty context on error
            }
        }

        // Handle sending a message
        async function handleSend() {
            const query = userInput.value.trim();
            if (query === "") return;

            addMessage(query, 'user');
            userInput.value = "";
            showLoading();

            try {
                // 1. Find relevant context
                const context = await findRelevantContext(query);
                
                // 2. Create the prompt for Gemini
                const prompt = `
                    You are a helpful assistant for a "Doodh Dairy Management" web app.
                    Answer the user's question based *only* on the context provided below.
                    If the answer is not in the context, politely say "I'm sorry, I don't have information about that."
                    Keep the answer concise and to the point.

                    CONTEXT:
                    ---
                    ${context}
                    ---

                    USER'S QUESTION:
                    ${query}

                    ANSWER:
                `;

                // 3. Call Gemini API
                const result = await generativeModel.generateContent(prompt);
                const response = result.response;
                const botReply = response.text();

                hideLoading();
                addMessage(botReply, 'bot');

            } catch (error) {
                console.error("Gemini API Error:", error);
                hideLoading();
                addMessage("Sorry, I'm having trouble thinking right now. Please try again.", 'bot');
            }
        }

        // --- 4. Event Listeners ---
        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSend();
            }
        });
        
        // Run startup logic
        document.addEventListener('DOMContentLoaded', initializeApp);


        // --- 5. Dark Mode Logic (Copied from your main file) ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('theme-icon-sun');
        const moonIcon = document.getElementById('theme-icon-moon');

        function applyTheme(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                document.body.classList.add('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                document.body.classList.remove('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
            // Update chat bubbles (remove and re-add dark classes)
            document.querySelectorAll('.chat-bubble-bot').forEach(b => {
                b.classList.toggle('dark:bg-gray-700', isDark);
                b.classList.toggle('dark:text-gray-100', isDark);
            });
            document.querySelectorAll('.chat-bubble-user').forEach(b => {
                b.classList.toggle('dark:bg-blue-600', isDark);
                b.classList.toggle('dark:text-white', isDark);
            });
        }

        themeToggleBtn.addEventListener('click', () => {
            const isDark = !document.documentElement.classList.contains('dark');
            localStorage.setItem('dairyTheme', isDark ? 'dark' : 'light');
            applyTheme(isDark);
        });

        // Apply saved theme on load
        applyTheme(localStorage.getItem('dairyTheme') === 'dark');

    </script>
</body>
</html>
