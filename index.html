<!DOCTYPE html>
<!-- Added dark mode class target -->
<html lang="hi" class=""> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doodh Dairy Management</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ✨ Change: Poppins Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- ✨ New: Tailwind Dark Mode Config -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    fontFamily: {
                        // Set Poppins as the default
                        sans: ['Poppins', 'sans-serif'], 
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            /* ✨ Change: Use Poppins font */
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7f6;
        }
        /* Page transition smoothness */
        [data-page] {
            display: none;
        }
        [data-page].active {
            display: block;
        }
        /* Simple modal style */
        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            transition: all 0.3s ease;
            max-height: 90vh;
        }
        .modal-backdrop.active, .modal-content.active {
            display: block;
        }
        /* For Gemini summary text */
        .prose {
            white-space: pre-wrap;
        }
        /* Language button styling */
        .lang-btn {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .lang-btn.active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
        }
        .lang-btn:not(.active) {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-700 */
        }
        
        /* History Modal Tab styling */
        .tab-btn {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6b7280; /* text-gray-500 */
        }
        .tab-btn.active {
            color: #3b82f6; /* text-blue-600 */
            border-bottom-color: #3b82f6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Chart filter button styling */
        .fat-filter-btn {
            transition: all 0.2s;
        }
        .fat-filter-btn.active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
        }
        .fat-filter-btn:not(.active) {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-700 */
        }
        
        /* ✨ New: Dark Mode Styles */
        body.dark {
            background-color: #111827; /* bg-gray-900 */
        }
        body.dark #login-view {
            background-color: #111827; /* bg-gray-900 */
        }
        body.dark #login-view > div.shadow-xl { /* Login card */
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
        }
        body.dark #sidebar {
            background-color: #1f2937; /* bg-gray-800 */
            border-right: 1px solid #374151; /* border-gray-700 */
        }
        body.dark .nav-link {
            color: #d1d5db; /* text-gray-300 */
        }
        body.dark .nav-link:hover {
            background-color: #374151; /* bg-gray-700 */
            color: #fff;
        }
        body.dark .nav-link.active {
            background-color: #374151; /* bg-gray-700 */
            color: #fff;
        }
        body.dark .md\:ml-64 { /* Main content area */
            background-color: #111827; /* bg-gray-900 */
        }
        body.dark header { /* Mobile header */
            background-color: #1f2937; /* bg-gray-800 */
            border-bottom: 1px solid #374151; /* border-gray-700 */
        }
        body.dark [data-page] h1, body.dark [data-page] h2 {
            color: #f3f4f6; /* text-gray-100 */
        }
        body.dark .bg-white {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
        }
        body.dark .bg-gray-50 {
            background-color: #374151; /* bg-gray-700 */
        }
        body.dark .text-gray-800 { color: #f3f4f6; /* text-gray-100 */ }
        body.dark .text-gray-900 { color: #f9fafb; /* text-gray-50 */ }
        body.dark .text-gray-700 { color: #d1d5db; /* text-gray-300 */ }
        body.dark .text-gray-600 { color: #9ca3af; /* text-gray-400 */ }
        body.dark .text-gray-500 { color: #a1a1aa; /* text-zinc-400 */ }
        body.dark .border-gray-300 { border-color: #4b5563; /* border-gray-600 */ }
        body.dark .border-gray-200 { border-color: #374151; /* border-gray-700 */ }
        body.dark input, body.dark select {
            background-color: #374151; /* bg-gray-700 */
            color: #f3f4f6; /* text-gray-100 */
        }
        body.dark input::placeholder { color: #6b7280; /* text-gray-500 */ }
        body.dark .lang-btn:not(.active) {
            background-color: #374151; /* bg-gray-700 */
            color: #d1d5db; /* text-gray-300 */
        }
        body.dark .fat-filter-btn:not(.active) {
            background-color: #374151; /* bg-gray-700 */
            color: #d1d5db; /* text-gray-300 */
        }
        body.dark .tab-btn { color: #9ca3af; /* text-gray-400 */ }
        body.dark .tab-btn.active { color: #60a5fa; /* text-blue-400 */ border-bottom-color: #60a5fa; }
        body.dark .prose { color: #d1d5db; }

        /* Icon button dark modes */
        body.dark .btn-payment {
            background-color: #064e3b; /* green-800 */
            color: #a7f3d0; /* green-200 */
        }
         body.dark .btn-payment:hover { background-color: #047857; /* green-700 */ }
        body.dark .btn-delete, body.dark .btn-delete-expense, body.dark .btn-delete-fat {
            background-color: #991b1b; /* red-800 */
            color: #fecaca; /* red-200 */
        }
        body.dark .btn-delete:hover, body.dark .btn-delete-expense:hover, body.dark .btn-delete-fat:hover {
             background-color: #b91c1c; /* red-700 */
        }
        /* ✨ New: Edit button dark mode */
        body.dark .btn-edit {
            background-color: #1e40af; /* blue-800 */
            color: #bfdbfe; /* blue-200 */
        }
        body.dark .btn-edit:hover { background-color: #1d4ed8; /* blue-700 */ }

        /* ✨ New: Chatbot FAB */
        .chat-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 30;
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            background-color: #6d28d9; /* purple-700 */
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .chat-fab:hover { background-color: #5b21b6; /* purple-800 */ transform: scale(1.05); }
        body.dark .chat-fab {
            background-color: #7e22ce; /* purple-600 */
        }
        body.dark .chat-fab:hover {
            background-color: #9333ea; /* purple-500 */
        }

        /* ✨ New: Chatbot Modal */
        #chat-modal-content {
            width: 90%;
            max-width: 40rem; /* Wider than other modals */
            height: 80vh;
            max-height: 800px;
            /* display: flex; <-- BUG: Removed this line. This was overriding the default "display: none" from .modal-content */
            flex-direction: column;
            overflow: hidden;
        }
        /* ✨ FIX: Add new rule to apply 'display: flex' only when 'active' class is added. */
        /* This is more specific and overrides the default ".modal-content.active { display: block; }" */
        #chat-modal-content.active {
            display: flex;
        }

        #chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .chat-message {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            line-height: 1.5;
            max-width: 85%;
            white-space: pre-wrap;
        }
        .chat-message-user {
            background-color: #e0e7ff; /* indigo-100 */
            color: #1f2937; /* text-gray-800 */
            margin-left: auto;
            align-self: flex-end;
        }
        .chat-message-gemini {
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* text-gray-800 */
            margin-right: auto;
            align-self: flex-start;
        }
        body.dark .chat-message-user {
            background-color: #3730a3; /* indigo-800 */
            color: #e0e7ff; /* indigo-100 */
        }
        body.dark .chat-message-gemini {
            background-color: #374151; /* gray-700 */
            color: #f3f4f6; /* gray-100 */
        }
        #chat-loading {
            display: none;
            padding: 1rem;
            text-align: center;
        }
    </style>
</head>
<body class="antialiased">

    <!-- ===== LOGIN VIEW (✨ Redesigned) ===== -->
    <div id="login-view" class="flex flex-col items-center justify-center min-h-screen bg-gray-200 dark:bg-gray-900 p-4">
        <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-xl shadow-xl">
            <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white" data-lang-key="adminLogin">Admin Login</h2>
            <p class="text-center text-gray-600 dark:text-gray-400" data-lang-key="dairyManagementSystem">Dairy Management System</p>
            
            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="email">Email</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" data-lang-placeholder="emailPlaceholder" placeholder="admin@email.com">
                </div>
                <div>
                    <label for="login-password" class="text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="password">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" data-lang-placeholder="passwordPlaceholder" placeholder="••••••••">
                </div>

                <!-- ✨ EXTRA FEATURE: Remember Me Checkbox -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-900 dark:text-gray-300" data-lang-key="rememberMe">Remember me</label>
                    </div>
                </div>

                <button type="submit" class="w-full py-2 font-semibold text-white bg-purple-600 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors" data-lang-key="login">Login</button>
            </form>
            
            <div class="text-center">
                <span class="text-sm text-gray-500 dark:text-gray-400" data-lang-key="newUser">Naye admin? </span>
                <button id="show-signup-btn" class="text-sm font-medium text-purple-600 dark:text-purple-400 hover:underline" data-lang-key="signupHere">Signup Yahan Karein</button>
            </div>

            <!-- Signup Form (Hidden initially) -->
            <form id="signup-form" class="hidden space-y-4">
                <h3 class="text-xl font-semibold text-center text-gray-800 dark:text-gray-200" data-lang-key="newAdminAccount">Naya Admin Account</h3>
                <div>
                    <label for="signup-email" class="text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="email">Email</label>
                    <input type="email" id="signup-email" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label for="signup-password" class="text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="password">Password</label>
                    <input type="password" id="signup-password" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <button type="submit" class="w-full py-2 font-semibold text-white bg-purple-600 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors" data-lang-key="signup">Signup</button>
                 <button type="button" id="show-login-btn" class="w-full text-sm font-medium text-purple-600 dark:text-purple-400 hover:underline" data-lang-key="backToLogin">Wapas Login pe Jayein</button>
            </form>

            <p id="auth-error" class="text-center text-red-500 text-sm"></p>
        </div>
        <!-- ✨ New: Credit on Login Page -->
        <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-8">Created by Aniket</p>
    </div>

    <!-- ===== ADMIN APP VIEW ===== -->
    <div id="admin-view" class="hidden">
        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden"></div>

        <!-- ✨ New ID added for Remote Config background control -->
        <div id="admin-view-wrapper" class="flex min-h-screen bg-gray-100 dark:bg-gray-900">
            <!-- Sidebar Navigation -->
            <nav id="sidebar" class="fixed inset-y-0 left-0 z-30 flex flex-col w-64 bg-white dark:bg-gray-800 shadow-lg transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
                <div class="flex items-center justify-center p-6 border-b dark:border-gray-700">
                    <i class="fas fa-mug-hot text-3xl text-blue-600 dark:text-blue-400"></i>
                    <span class="ml-3 text-2xl font-bold text-gray-800 dark:text-gray-100" data-lang-key="dairyAdmin">Dairy Admin</span>
                </div>
                <div class="flex-1 overflow-y-auto">
                    <ul class="py-4">
                        <!-- Navigation Links -->
                        <li class="px-6 py-3">
                            <a href="#dashboard" class="nav-link flex items-center text-gray-700 hover:text-blue-600 hover:bg-gray-100 rounded-md p-2 transition-colors dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white">
                                <i class="fas fa-tachometer-alt w-6 text-center"></i>
                                <span class="ml-3 font-medium" data-lang-key="dashboard">Dashboard</span>
                            </a>
                        </li>
                        <li class="px-6 py-3">
                            <a href="#customers" class="nav-link flex items-center text-gray-700 hover:text-blue-600 hover:bg-gray-100 rounded-md p-2 transition-colors dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white">
                                <i class="fas fa-users w-6 text-center"></i>
                                <span class="ml-3 font-medium" data-lang-key="customers">Grahak (Customers)</span>
                            </a>
                        </li>
                        <li class="px-6 py-3">
                            <a href="#daily-log" class="nav-link flex items-center text-gray-700 hover:text-blue-600 hover:bg-gray-100 rounded-md p-2 transition-colors dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white">
                                <i class="fas fa-clipboard-list w-6 text-center"></i>
                                <span class="ml-3 font-medium" data-lang-key="dailyLog">Roz ka Hisaab</span>
                            </a>
                        </li>
                        <!-- New Fat Log Link -->
                        <li class="px-6 py-3">
                            <a href="#fat-log" class="nav-link flex items-center text-gray-700 hover:text-blue-600 hover:bg-gray-100 rounded-md p-2 transition-colors dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white">
                                <i class="fas fa-percentage w-6 text-center"></i>
                                <span class="ml-3 font-medium" data-lang-key="fatLog">Fat Log</span>
                            </a>
                        </li>
                        <!-- ✨ Remote Config: Expenses Link Wrapper -->
                        <li id="nav-expenses-wrapper" class="px-6 py-3">
                            <a href="#expenses" class="nav-link flex items-center text-gray-700 hover:text-blue-600 hover:bg-gray-100 rounded-md p-2 transition-colors dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white">
                                <i class="fas fa-money-bill-wave w-6 text-center"></i>
                                <span class="ml-3 font-medium" data-lang-key="expenses">Kharche (Expenses)</span>
                            </a>
                        </li>
                        <li class="px-6 py-3">
                            <a href="#settings" class="nav-link flex items-center text-gray-700 hover:text-blue-600 hover:bg-gray-100 rounded-md p-2 transition-colors dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white">
                                <i class="fas fa-cog w-6 text-center"></i>
                                <span class="ml-3 font-medium" data-lang-key="settings">Settings</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <!-- ✨ New: Theme Toggle -->
                <!-- ✨ New: Added ID for Remote Config -->
                <div id="theme-toggle-wrapper" class="px-4 mb-3 border-t pt-4 dark:border-gray-700">
                    <button id="theme-toggle" class="w-full flex items-center justify-center py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-semibold rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <i id="theme-icon-sun" class="fas fa-sun hidden mr-2 text-yellow-500"></i>
                        <i id="theme-icon-moon" class="fas fa-moon mr-2 text-yellow-500"></i>
                        <span id="theme-text-light" data-lang-key="switchToDark">Switch to Dark</span>
                        <span id="theme-text-dark" data-lang-key="switchToLight" class="hidden">Switch to Light</span>
                    </button>
                </div>
                <!-- ✨ Remote Config: Language Switcher Wrapper -->
                <div id="language-switcher-wrapper" class="p-4 border-t dark:border-gray-700">
                    <div class="flex justify-around mb-3">
                        <button class="lang-btn" data-lang="en">English</button>
                    <button class="lang-btn" data-lang="mr">मराठी</button>
                </div>
                <!-- ✨ Remote Config: Logout Button Wrapper -->
                <div id="logout-btn-wrapper">
                    <button id="logout-btn" class="w-full flex items-center justify-center py-2 px-4 bg-red-500 text-white font-semibold rounded-md hover:bg-red-600 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        <span data-lang-key="logout">Logout</span>
                    </button>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 truncate"><span data-lang-key="adminId">Admin ID</span>: <span id="admin-user-id"></span></p>
                </div>
            </nav>

            <!-- Main Content Area -->
            <div class="flex-1 flex flex-col md:ml-64">
                <!-- Mobile Header -->
                <header class="sticky top-0 bg-white dark:bg-gray-800 shadow-md p-4 md:hidden flex justify-between items-center z-10 dark:border-b dark:border-gray-700">
                    <button id="menu-toggle-btn" class="text-2xl text-gray-700 dark:text-gray-300">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="text-xl font-bold text-blue-600 dark:text-blue-400" data-lang-key="dairyAdmin">Dairy Admin</h1>
                    <div></div> <!-- Spacer -->
                </header>

                <!-- ✨ Remote Config: Main app background wrapper -->
                <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto">
                    
                    <!-- ===== Dashboard Page ===== -->
                    <div id="dashboard-page" data-page class="active">
                        <h1 class="text-3xl font-bold text-gray-800 mb-6 dark:text-gray-100" data-lang-key="dashboard">Dashboard</h1>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <!-- Stat Card 1 -->
                            <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md">
                                <div class="flex items-center">
                                    <div class="p-3 bg-blue-100 dark:bg-blue-900 rounded-full">
                                        <i class="fas fa-users text-2xl text-blue-600 dark:text-blue-300"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-key="totalCustomers">Kul Grahak</p>
                                        <p id="stat-total-customers" class="text-3xl font-bold text-gray-900 dark:text-gray-50">0</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Stat Card 2 -->
                            <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md">
                                <div class="flex items-center">
                                    <div class="p-3 bg-red-100 dark:bg-red-900 rounded-full">
                                        <i class="fas fa-wallet text-2xl text-red-600 dark:text-red-300"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-key="totalBalance">Total Bakaaya</p>
                                        <p id="stat-total-balance" class="text-3xl font-bold text-gray-900 dark:text-gray-50">₹0.00</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Stat Card 3 -->
                            <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md">
                                <div class="flex items-center">
                                    <div class="p-3 bg-red-100 dark:bg-red-900 rounded-full">
                                        <i class="fas fa-shopping-cart text-2xl text-red-600 dark:text-red-300"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-key="monthlyExpenses">Is Mahine ka Kharcha</p>
                                        <p id="stat-total-expenses" class="text-3xl font-bold text-gray-900 dark:text-gray-50">₹0.00</p>
                                    </div>
                                </div>
                            </div>
                             <!-- Stat Card 4 - Today's Fat -->
                            <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md">
                                <div class="flex items-center">
                                    <div class="p-3 bg-yellow-100 dark:bg-yellow-900 rounded-full">
                                        <i class="fas fa-percentage text-2xl text-yellow-600 dark:text-yellow-300"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-key="todayFat">Today's Fat</p>
                                        <p id="stat-today-fat" class="text-3xl font-bold text-gray-900 dark:text-gray-50">--</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Stat Card 5 (New) - Monthly Payments Received -->
                            <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md">
                                <div class="flex items-center">
                                    <div class="p-3 bg-green-100 dark:bg-green-900 rounded-full">
                                        <i class="fas fa-hand-holding-dollar text-2xl text-green-600 dark:text-green-300"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-key="monthlyPayments">Payments Received (Month)</p>
                                        <p id="stat-total-payments" class="text-3xl font-bold text-gray-900 dark:text-gray-50">₹0.00</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ✨ New: Gemini Summary Buttons Wrapper -->
                        <div id="gemini-summary-wrapper" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- ✨ New: Gemini Income Summary Button -->
                            <button id="get-income-summary-btn" class="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition-colors">
                                <i class="fas fa-magic-sparkles mr-2"></i> 
                                <span data-lang-key="getGeminiIncomeSummary">Get Monthly Income Summary (Gemini)</span>
                            </button>
                            <!-- ✨ New: Gemini Expense Summary Button (Moved) -->
                            <button id="get-expense-summary-btn-dash" class="w-full py-3 px-4 bg-purple-600 text-white font-semibold rounded-md hover:bg-purple-700 transition-colors">
                                <i class="fas fa-magic-sparkles mr-2"></i> 
                                <span data-lang-key="getGeminiSummary">Get Monthly Expense Summary (Gemini)</span>
                            </button>
                        </div>


                        <!-- New Fat Chart -->
                        <div class="mt-8 bg-white dark:bg-gray-800 p-4 md:p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-semibold mb-4 dark:text-gray-100" data-lang-key="fatHistory">Fat History</h2>
                            <div class="flex justify-center flex-wrap space-x-2 mb-4">
                                <button class="fat-filter-btn px-3 py-1 text-sm rounded-md active" data-days="7">7 Days</button>
                                <button class="fat-filter-btn px-3 py-1 text-sm rounded-md" data-days="30">30 Days</button>
                                <button class="fat-filter-btn px-3 py-1 text-sm rounded-md" data-days="0">All Time</button>
                            </div>
                            <div class="h-64 md:h-80">
                                <canvas id="fat-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- ===== Customers Page ===== -->
                    <div id="customers-page" data-page>
                        <h1 class="text-3xl font-bold text-gray-800 mb-6 dark:text-gray-100" data-lang-key="manageCustomers">Grahak Manage Karein</h1>
                        
                        <!-- Add Customer Form -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
                            <h2 class="text-xl font-semibold mb-4 dark:text-gray-100" data-lang-key="addNewCustomer">Naya Grahak Jodein</h2>
                            <form id="add-customer-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text" id="customer-name" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" data-lang-placeholder="customerName" placeholder="Grahak ka Naam" required>
                                <input type="tel" id="customer-phone" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" data-lang-placeholder="phoneNumber" placeholder="Phone Number">
                                <input type="text" id="customer-address" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" data-lang-placeholder="address" placeholder="Address">
                                <input type="number" step="0.5" min="0" id="customer-qty" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" data-lang-placeholder="defaultMilk" placeholder="Default Doodh (Liters)" required>
                                
                                <select id="customer-milk-type" class="p-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600">
                                    <option value="cow" data-lang-key="cowMilk">Cow Milk</option>
                                    <option value="buffalo" data-lang-key="buffaloMilk">Buffalo Milk</option>
                                </select>
                                <select id="customer-shift" class="p-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600">
                                    <option value="morning" data-lang-key="morningShift">Morning Shift</option>
                                    <option value="evening" data-lang-key="eveningShift">Evening Shift</option>
                                </select>
                                
                                <button type="submit" class="md:col-span-3 w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors" data-lang-key="addCustomer">Add Grahak</button>
                            </form>
                        </div>

                        <!-- Customer List -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-x-auto">
                             <h2 class="text-xl font-semibold p-6 dark:text-gray-100" data-lang-key="customerList">Grahak ki List</h2>
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="name">Naam</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="milkType">Milk Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="shift">Shift</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="defaultQty">Default Qty</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="balanceAmount">Bakaaya Raashi</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customer-list" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                                    <!-- Customer rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ===== Daily Log Page ===== -->
                    <div id="daily-log-page" data-page>
                        <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-2">
                            <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100" data-lang-key="dailyLog">Roz ka Hisaab</h1>
                            <p class="text-lg text-gray-600 dark:text-gray-300"><span data-lang-key="todayDate">Aaj ki Taarikh</span>: <span id="today-date"></span></p>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md mt-6 overflow-x-auto">
                            <div class="p-4 border-b dark:border-gray-700 space-y-1">
                                <p class="text-sm text-gray-600 dark:text-gray-300"><span data-lang-key="cowMilkRate">Cow Milk Rate</span>: <span id="log-cow-milk-price" class="font-bold text-blue-600 dark:text-blue-400">₹0/L</span></p>
                                <p class="text-sm text-gray-600 dark:text-gray-300"><span data-lang-key="buffaloMilkRate">Buffalo Milk Rate</span>: <span id="log-buffalo-milk-price" class="font-bold text-blue-600 dark:text-blue-400">₹0/L</span></p>
                                <p class="text-xs text-gray-500 dark:text-gray-400" data-lang-key="setFromSettings">Settings se set karein</p>
                            </div>
                            <form id="daily-log-form">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="milkDelivered">Doodh Diya?</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="customer">Grahak</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="quantityLiters">Kitna (Liters)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="daily-log-list" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                                        <!-- Daily log rows will be injected here -->
                                    </tbody>
                                </table>
                                <div class="p-6 bg-gray-50 dark:bg-gray-800 border-t dark:border-gray-700">
                                    <button type="submit" class="w-full py-3 px-6 bg-green-600 text-white font-bold rounded-md hover:bg-green-700 transition-colors text-lg">
                                        <i class="fas fa-save mr-2"></i>
                                        <span data-lang-key="saveTodayLog">Aaj ka Hisaab Save Karein</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- ===== New Fat Log Page ===== -->
                    <div id="fat-log-page" data-page>
                        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-6" data-lang-key="manageFatLog">Manage Fat Log</h1>
                        
                        <!-- Add Fat Entry Form -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
                            <h2 class="text-xl font-semibold mb-4 dark:text-gray-100" data-lang-key="addFatEntry">Add New Fat Entry</h2>
                            <form id="add-fat-log-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="date" id="fat-date" class="p-2 border rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required>
                                <input type="number" step="0.1" min="0" id="fat-value" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" data-lang-placeholder="fatValuePlaceholder" placeholder="Fat Value (e.g., 8.7)" required>
                                <button type="submit" class="md:col-span-3 w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors" data-lang-key="addEntry">Add Entry</button>
                            </form>
                        </div>

                        <!-- Fat Log List -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-x-auto">
                            <h2 class="text-xl font-semibold p-6 dark:text-gray-100" data-lang-key="fatLogList">Fat Log List</h2>
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="date">Taarikh</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="fatValue">Fat Value</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="fat-log-list" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                                    <!-- Fat log rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ===== Expenses Page ===== -->
                    <div id="expenses-page" data-page>
                        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-6" data-lang-key="manageExpenses">Kharche Manage Karein</h1>
                        
                        <!-- Add Expense Form -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
                            <h2 class="text-xl font-semibold mb-4 dark:text-gray-100" data-lang-key="addNewExpense">Naya Kharcha Jodein</h2>
                            <form id="add-expense-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="date" id="expense-date" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" required>
                                <input type="text" id="expense-desc" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" data-lang-placeholder="expenseDescription" placeholder="Kharcha ka Vivaran" required>
                                <input type="number" step="0.01" min="0" id="expense-amount" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" data-lang-placeholder="amountPlaceholder" placeholder="Raashi (₹)" required>
                                <button type="submit" class="md:col-span-3 w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors" data-lang-key="addExpense">Add Kharcha</button>
                            </form>
                        </div>

                        <!-- ✨ Remote Config: Gemini Summary Button Wrapper -->
                        <div id="gemini-expense-btn-wrapper">
                            <button id="get-expense-summary-btn" class="mb-6 w-full py-2 px-4 bg-purple-600 text-white font-semibold rounded-md hover:bg-purple-700 transition-colors">
                                <i class="fas fa-magic-sparkles mr-2"></i> 
                                <span data-lang-key="getGeminiSummary">Get Monthly Expense Summary (with Gemini)</span>
                            </button>
                        </div>

                        <!-- Expense List -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-x-auto">
                             <h2 class="text-xl font-semibold p-6 dark:text-gray-100" data-lang-key="expenseList">Kharche ki List</h2>
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="date">Taarikh</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="description">Vivaran</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="amount">Raashi</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-lang-key="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expense-list" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                                    <!-- Expense rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ===== Settings Page ===== -->
                    <div id="settings-page" data-page>
                        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-6" data-lang-key="settings">Settings</h1>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md max-w-lg">
                            <h2 class="text-xl font-semibold mb-4 dark:text-gray-100" data-lang-key="setMilkRate">Doodh ka Rate Set Karein</h2>
                            <form id="settings-form" class="space-y-4">
                                <!-- Cow Milk Rate -->
                                <div>
                                    <label for="milk-price-cow" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="cowMilkRate">Cow Milk Rate (per liter)</label>
                                    <input type="number" step="0.01" min="0" id="milk-price-cow" class="mt-1 p-2 w-full border rounded-md dark:bg-gray-700 dark:border-gray-600" data-lang-placeholder="milkRateExample" placeholder="e.g., 50.50">
                                </div>
                                <!-- Buffalo Milk Rate -->
                                <div>
                                    <label for="milk-price-buffalo" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="buffaloMilkRate">Buffalo Milk Rate (per liter)</label>
                                    <input type="number" step="0.01" min="0" id="milk-price-buffalo" class="mt-1 p-2 w-full border rounded-md dark:bg-gray-700 dark:border-gray-600" data-lang-placeholder="milkRateExample" placeholder="e.g., 65.00">
                                </div>
                                <button type="submit" class="w-full py-2 px-4 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition-colors" data-lang-key="saveSettings">
                                    Save Settings
                                </button>
                            </form>
                        </div>
                    </div>

                </main>
                <!-- ✨ New: Credit in Main App Footer -->
                <footer class="text-center text-sm text-gray-500 dark:text-gray-400 py-4 mt-auto border-t border-gray-200 dark:border-gray-700">
                    Created by Aniket
                </footer>
            </div>
        </div>
    </div>

    <!-- ===== Payment Modal ===== -->
    <div id="payment-modal-backdrop" class="modal-backdrop"></div>
    <div id="payment-modal-content" class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm">
        <h2 class="text-xl font-semibold mb-4 dark:text-gray-100" data-lang-key="receivePayment">Payment Receive Karein</h2>
        <p class="mb-2 dark:text-gray-300"><span data-lang-key="customer">Grahak</span>: <span id="payment-customer-name" class="font-bold"></span></p>
        <p class="mb-4 dark:text-gray-300"><span data-lang-key="currentBalance">Current Bakaaya</span>: <span id="payment-customer-balance" class="font-bold"></span></p>
        <form id="payment-form">
            <input type="hidden" id="payment-customer-id">
            <div>
                <label for="payment-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="paymentAmount">Payment Raashi (₹)</label>
                <input type="number" step="0.01" min="0" id="payment-amount" class="mt-1 p-2 w-full border rounded-md dark:bg-gray-700 dark:border-gray-600" required>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="cancel-payment-btn" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 transition-colors" data-lang-key="cancel">Cancel</button>
                <button type="submit" class="py-2 px-4 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition-colors" data-lang-key="addPayment">Add Payment</button>
            </div>
        </form>
    </div>

    <!-- ===== Gemini Summary Modal ===== -->
    <div id="summary-modal-backdrop" class="modal-backdrop"></div>
    <div id="summary-modal-content" class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg">
        <div class="flex justify-between items-center mb-4">
            <!-- ✨ New: Dynamic Title for Summary Modal -->
            <h2 id="summary-modal-title" class="text-xl font-semibold dark:text-gray-100" data-lang-key="geminiSummaryTitle">Gemini Expense Summary</h2>
            <button id="close-summary-btn" class="text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100 text-2xl">&times;</button>
        </div>
        <div id="summary-loading" class="text-center p-4">
            <i class="fas fa-spinner fa-spin text-3xl text-blue-500 dark:text-blue-400"></i>
            <p id="summary-loading-text" class="mt-2 text-gray-600 dark:text-gray-300" data-lang-key="geminiLoading">Gemini se summary generate kar rahe hain...</p>
        </div>
        <div id="summary-result" class="prose max-w-none text-gray-700 dark:text-gray-200" style="display: none;">
            <!-- Gemini response will be injected here -->
        </div>
    </div>
    
    <!-- ===== Customer History Modal ===== -->
    <div id="history-modal-backdrop" class="modal-backdrop"></div>
    <div id="history-modal-content" class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl overflow-hidden">
        <!-- Modal Header -->
        <div class="flex justify-between items-center p-5 border-b dark:border-gray-700">
            <div>
                <h2 class="text-xl font-semibold dark:text-gray-100" id="history-customer-name">Customer History</h2>
                <!-- Updated Info Section -->
                <div id="history-customer-info" class="text-sm text-gray-600 dark:text-gray-300 mt-2">
                    <!-- Details will be injected here -->
                </div>
            </div>
            <button id="close-history-btn" class="text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100 text-3xl">&times;</button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-5 flex flex-col">
            <!-- Tabs -->
            <div class="border-b border-gray-200 dark:border-gray-700 mb-4">
                <nav class="flex -mb-px">
                    <button class="tab-btn active" data-tab="milk-history" data-lang-key="milkHistory">Milk History</button>
                    <button class="tab-btn" data-tab="payment-history" data-lang-key="paymentHistory">Payment History</button>
                </nav>
            </div>
            
            <!-- Tab Content -->
            <div class="flex-1 overflow-y-auto" style="max-height: 60vh;">
                <!-- Milk History Tab -->
                <div id="milk-history-content" class="tab-content active">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase" data-lang-key="date">Date</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase" data-lang-key="status">Status</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase" data-lang-key="quantity">Quantity</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase" data-lang-key="amount">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="milk-history-list" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Milk history rows will be injected here -->
                        </tbody>
                    </table>
                    <p id="no-milk-history" class="p-4 text-center text-gray-500 dark:text-gray-400" data-lang-key="noMilkHistory" style="display: none;"></p>
                </div>
                
                <!-- Payment History Tab -->
                <div id="payment-history-content" class="tab-content">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase" data-lang-key="date">Date</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase" data-lang-key="amountPaid">Amount Paid</th>
                            </tr>
                        </thead>
                        <tbody id="payment-history-list" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Payment history rows will be injected here -->
                        </tbody>
                    </table>
                     <p id="no-payment-history" class="p-4 text-center text-gray-500 dark:text-gray-400" data-lang-key="noPaymentHistory" style="display: none;"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== Custom Confirm Modal (New) ===== -->
    <div id="confirm-modal-backdrop" class="modal-backdrop"></div>
    <div id="confirm-modal-content" class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm">
        <h2 id="confirm-modal-title" class="text-xl font-semibold mb-4 dark:text-gray-100">Confirm Action</h2>
        <p id="confirm-modal-body" class="mb-6 text-gray-700 dark:text-gray-300">Are you sure?</p>
        <div class="flex justify-end space-x-3">
            <button type="button" id="confirm-modal-cancel" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 transition-colors" data-lang-key="cancel">Cancel</button>
            <button type="button" id="confirm-modal-confirm" class="py-2 px-4 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition-colors" data-lang-key="confirm">Confirm</button>
        </div>
    </div>

    <!-- ===== ✨ New: Edit Customer Modal ===== -->
    <div id="edit-customer-modal-backdrop" class="modal-backdrop"></div>
    <div id="edit-customer-modal-content" class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg">
        <h2 class="text-xl font-semibold mb-4 dark:text-gray-100" data-lang-key="editCustomer">Edit Customer</h2>
        <form id="edit-customer-form" class="space-y-4">
            <input type="hidden" id="edit-customer-id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="edit-customer-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="name">Name</label>
                    <input type="text" id="edit-customer-name" class="mt-1 p-2 w-full border rounded-md dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div>
                    <label for="edit-customer-phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="phone">Phone</label>
                    <input type="tel" id="edit-customer-phone" class="mt-1 p-2 w-full border rounded-md dark:bg-gray-700 dark:border-gray-600">
                </div>
            </div>
            
            <div>
                <label for="edit-customer-address" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="address">Address</label>
                <input type="text" id="edit-customer-address" class="mt-1 p-2 w-full border rounded-md dark:bg-gray-700 dark:border-gray-600">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="edit-customer-qty" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="defaultQty">Default Qty</label>
                    <input type="number" step="0.5" min="0" id="edit-customer-qty" class="mt-1 p-2 w-full border rounded-md dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div>
                    <label for="edit-customer-milk-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="milkType">Milk Type</label>
                    <select id="edit-customer-milk-type" class="mt-1 p-2 w-full border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600">
                        <option value="cow" data-lang-key="cowMilk">Cow Milk</option>
                        <option value="buffalo" data-lang-key="buffaloMilk">Buffalo Milk</option>
                    </select>
                </div>
                <div>
                    <label for="edit-customer-shift" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="shift">Shift</label>
                    <select id="edit-customer-shift" class="mt-1 p-2 w-full border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600">
                        <option value="morning" data-lang-key="morningShift">Morning Shift</option>
                        <option value="evening" data-lang-key="eveningShift">Evening Shift</option>
                    </select>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="cancel-edit-customer-btn" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 transition-colors" data-lang-key="cancel">Cancel</button>
                <button type="submit" class="py-2 px-4 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors" data-lang-key="saveChanges">Save Changes</button>
            </div>
        </form>
    </div>


    <!-- ✨ New: Chatbot FAB (Floating Action Button) -->
    <div id="chatbot-fab-wrapper" class="hidden">
        <button id="chatbot-fab-btn" class="chat-fab flex items-center justify-center" title="Chat with Gemini">
            <i class="fas fa-magic-sparkles text-2xl"></i>
        </button>
    </div>

    <!-- ✨ New: Chatbot Modal -->
    <div id="chat-modal-backdrop" class="modal-backdrop"></div>
    <div id="chat-modal-content" class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg">
        <!-- Header -->
        <div class="flex justify-between items-center p-4 border-b dark:border-gray-700">
            <h2 class="text-xl font-semibold dark:text-gray-100" data-lang-key="geminiChatbot">Gemini Helper</h2>
            <button id="close-chat-btn" class="text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100 text-2xl">&times;</button>
        </div>
        
        <!-- Chat History -->
        <div id="chat-history" class="bg-gray-50 dark:bg-gray-900">
            <!-- Messages will be appended here -->
             <div class="chat-message chat-message-gemini" data-lang-key="geminiChatWelcome">
                Hi! I'm your Gemini assistant. How can I help you with the app today?
             </div>
        </div>

        <!-- Loading Indicator -->
        <div id="chat-loading" class="p-4 border-t dark:border-gray-700">
            <div class="flex items-center justify-center">
                <i class="fas fa-spinner fa-spin text-blue-500 dark:text-blue-400"></i>
                <span class="ml-2 text-gray-600 dark:text-gray-300" data-lang-key="geminiThinking">Gemini is thinking...</span>
            </div>
        </div>
        
        <!-- Input Form -->
        <form id="chat-form" class="p-4 border-t dark:border-gray-700">
            <div class="flex items-center space-x-2">
                <input type="text" id="chat-input" class="p-2 w-full border rounded-md dark:bg-gray-700 dark:border-gray-600" data-lang-placeholder="typeYourQuestion" placeholder="Type your question...">
                <button type="submit" class="py-2 px-4 bg-purple-600 text-white font-semibold rounded-md hover:bg-purple-700 transition-colors">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
    </div>


    <!-- Global Status Toast -->
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-green-600 text-white py-3 px-5 rounded-lg shadow-xl transition-all duration-300 transform translate-y-10 opacity-0 z-50">
        <p id="toast-message">Success!</p>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // ===== 1. CONFIGURATION =====

        // User's Firebase Config
        // WARNING: Do not expose your API keys in production code.
        // This config is used because the user provided it.
        const firebaseConfig = {
          apiKey: "AIzaSyCE5FuoOTKLQV9tKf7jsXwS4-YIF3PCAYs",
          authDomain: "ecom-25960.firebaseapp.com",
          databaseURL: "https://ecom-25960-default-rtdb.firebaseio.com",
          projectId: "ecom-25960",
          storageBucket: "ecom-25960.firebasestorage.app",
          messagingSenderId: "616836239037",
          appId: "1:616836239037:web:a60ad5a141979e036831d4",
          measurementId: "G-H4QLD1RZ5V"
        };

        // User's Gemini API Key
        // WARNING: This is a major security risk. API keys should be on a server.
        const GEMINI_API_KEY = ""; // ✨ FIX: Leave empty for Canvas environment

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut,
            setPersistence, // ✨ EXTRA: Import persistence
            browserSessionPersistence, // ✨ EXTRA: Import persistence
            browserLocalPersistence // ✨ EXTRA: Import persistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc,
            getDocs,
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query,
            orderBy,
            writeBatch,
            increment,
            Timestamp,
            collectionGroup // New: For dashboard calculation
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // ✨ New: Remote Config Import
        import { getRemoteConfig, fetchAndActivate, getBoolean, getString, getValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-remote-config.js";


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // ✨ New: Initialize Remote Config
        const remoteConfig = getRemoteConfig(app);
        // ✨ New: Remote Config default settings
        // ✨ FIX: Changed minimumFetchIntervalMillis to 10 seconds for development
        remoteConfig.settings.minimumFetchIntervalMillis = 10000; // 10 seconds (was 3600000)
        remoteConfig.defaultConfig = {
            "show_expenses_manager": true,
            "show_language_switcher": true,
            "show_gemini_summary": true,
            "app_background_color": "#f4f7f6", // Default light gray
            "app_background_image_url": "", // ✨ New: Background image URL
            "show_gemini_chatbot": true, // ✨ New: Chatbot toggle
            "show_theme_toggle": true, // ✨ New: Theme toggle
            "show_logout_button": true // ✨ New: Logout button toggle
        };


        // ===== 2. TRANSLATIONS =====
        const translations = {
            en: {
                // Login / General
                adminLogin: "Admin Login",
                dairyManagementSystem: "Dairy Management System",
                email: "Email",
                password: "Password",
                login: "Login",
                rememberMe: "Remember me", // ✨ EXTRA
                newUser: "New admin?",
                signupHere: "Signup Here",
                newAdminAccount: "New Admin Account",
                signup: "Signup",
                backToLogin: "Back to Login",
                dairyAdmin: "Dairy Admin",
                logout: "Logout",
                adminId: "Admin ID",
                cancel: "Cancel",
                confirm: "Confirm", // New
                switchToDark: "Switch to Dark", // New
                switchToLight: "Switch to Light", // New
                
                // Navigation
                dashboard: "Dashboard",
                customers: "Customers",
                dailyLog: "Daily Log",
                fatLog: "Fat Log",
                expenses: "Expenses",
                settings: "Settings",

                // Dashboard
                totalCustomers: "Total Customers",
                totalBalance: "Total Balance",
                monthlyExpenses: "This Month's Expenses",
                monthlyPayments: "Payments Received (Month)", // New
                todayFat: "Today's Fat",
                fatHistory: "Fat History",
                getGeminiIncomeSummary: "Get Monthly Income Summary (Gemini)", // New
                geminiIncomeSummaryTitle: "Gemini Income Summary", // New
                geminiIncomeLoading: "Generating income summary...", // New
                geminiNoIncome: "No payments received this month for summary.", // New
                geminiIncomeSystemPrompt: "You are a helpful diary manager assistant. You are given a list of payments received. Based on this, provide a very short (2-3 line) summary in simple English. State the total income and mention how many payments were received.", // New
                geminiIncomeUserPrompt: "Here are my payments received this month:\n{data}\n\nPlease provide the summary.", // New

                // Customers Page
                manageCustomers: "Manage Customers",
                addNewCustomer: "Add New Customer",
                addCustomer: "Add Customer",
                customerList: "Customer List",
                name: "Name",
                milkType: "Milk Type",
                shift: "Shift",
                defaultQty: "Default Qty",
                balanceAmount: "Balance Amount",
                actions: "Actions",
                customerName: "Customer Name",
                phoneNumber: "Phone Number",
                address: "Address",
                defaultMilk: "Default Milk (Liters)",
                cowMilk: "Cow Milk",
                buffaloMilk: "Buffalo Milk",
                morningShift: "Morning Shift",
                eveningShift: "Evening Shift",
                payment: "Payment",
                history: "History",
                delete: "Delete",
                phone: "Phone", // New
                address: "Address", // New
                details: "Details", // New
                editCustomer: "Edit Customer", // ✨ New
                saveChanges: "Save Changes", // ✨ New
                edit: "Edit", // ✨ New

                // Daily Log
                todayDate: "Today's Date",
                cowMilkRate: "Cow Milk Rate",
                buffaloMilkRate: "Buffalo Milk Rate",
                setFromSettings: "Set rates from Settings page",
                milkDelivered: "Milk Delivered?",
                customer: "Customer",
                quantityLiters: "Quantity (Liters)",
                saveTodayLog: "Save Today's Log",

                // Fat Log
                manageFatLog: "Manage Fat Log",
                addFatEntry: "Add New Fat Entry",
                fatValuePlaceholder: "Fat Value (e.g., 8.7)",
                addEntry: "Add Entry",
                fatLogList: "Fat Log List",
                date: "Date",
                fatValue: "Fat Value",
                
                // Expenses
                manageExpenses: "Manage Expenses",
                addNewExpense: "Add New Expense",
                expenseDescription: "Expense Description",
                amountPlaceholder: "Amount (₹)",
                addExpense: "Add Expense",
                getGeminiSummary: "Get Monthly Expense Summary (with Gemini)",
                expenseList: "Expense List",
                description: "Description",
                amount: "Amount",
                
                // Settings
                setMilkRate: "Set Milk Rates",
                milkRateExample: "e.g., 50.50",
                saveSettings: "Save Settings",

                // Modals & Toasts
                receivePayment: "Receive Payment",
                currentBalance: "Current Balance",
                paymentAmount: "Payment Amount (₹)",
                addPayment: "Add Payment",
                geminiSummaryTitle: "Gemini Expense Summary",
                geminiLoading: "Generating summary from Gemini...",
                geminiNoExpenses: "No expenses found for this month to summarize.",
                geminiError: "Error generating summary: ",
                geminiSystemPrompt: "You are a helpful diary manager assistant. You are given a list of expenses in 'Taarikh (Date), Vivaran (Description), Raashi (Amount)' format. Based on this, provide a very short (2-3 line) summary in simple English. State the total expenses and maybe point out the biggest expense category if obvious.",
                geminiUserPrompt: "Here are my expenses for this month:\n{data}\n\nPlease provide the summary.",
                
                // History Modal
                milkHistory: "Milk History",
                paymentHistory: "Payment History",
                status: "Status",
                quantity: "Quantity",
                amountPaid: "Amount Paid",
                present: "Present",
                absent: "Absent",
                
                // Placeholders
                emailPlaceholder: "admin@email.com",
                passwordPlaceholder: "••••••••",

                // Errors & Success
                loginError: "Error logging in. Please check email/password.",
                signupError: "Error signing up.",
                "auth/invalid-email": "Invalid email address.",
                "auth/user-not-found": "No admin found with this email.",
                "auth/wrong-password": "Wrong password.",
                "auth/email-already-in-use": "This email is already registered.",
                "auth/weak-password": "Password should be at least 6 characters.",
                "auth/operation-not-allowed": "Email/Password login is not enabled. Contact developer.",
                error: "Error: ",
                settingsSaved: "Settings saved successfully!",
                customerAdded: "Customer added successfully!",
                logSaved: "Today's log saved!",
                paymentAdded: "Payment added successfully!",
                expenseAdded: "Expense added successfully!",
                fatEntryAdded: "Fat entry added successfully!", // New
                nameAndQtyRequired: "Name and Default Qty are required.",
                allFieldsRequired: "All fields are required.",
                milkRateRequired: "Please set milk rates in Settings first!",
                noCustomersForLog: "No customers found. Add customers first.",
                noExpenses: "No expenses logged yet.",
                noFatLog: "No fat log entries yet.", // New
                noMilkHistory: "No milk delivery history found for this customer.",
                noPaymentHistory: "No payment history found for this customer.",
                confirmDeleteCustomer: "Are you sure you want to delete this customer? This action cannot be undone.",
                confirmDeleteExpense: "Are you sure you want to delete this expense?",
                confirmDeleteFat: "Are you sure you want to delete this fat log entry?", // New
                customerAdded: "Customer added successfully!",
                customerUpdated: "Customer details updated!", // ✨ New
                customerDeleted: "Customer deleted.",
                expenseDeleted: "Expense deleted.",
                fatLogDeleted: "Fat log entry deleted.", // New
                confirmLogSaveTitle: "Confirm Log Save",
                confirmLogSaveText: "Are you sure you want to save today's log? This will update customer balances.",

                // ✨ New: Chatbot
                geminiChatbot: "Lacto Helper",
                chatWithGemini: "Chat with Lacto",
                typeYourQuestion: "Type your question...",
                send: "Send",
                geminiChatWelcome: "Hi! I'm Lacto, your assistant. How can I help you with the app today?",
                geminiThinking: "Lacto is thinking...",
                geminiChatSystemPrompt: "You are Lacto, a helpful assistant for the 'Doodh Dairy Management' web app. An admin is asking you a question. Answer concisely in simple, friendly English. If the question is about the app, explain how features like 'Dashboard', 'Customers', 'Daily Log', 'Fat Log', 'Expenses', or 'Settings' work. If it's a general question (like 'what is the capital of France'), just answer it.",
            },
            mr: {
                // Login / General
                adminLogin: "प्रशासक लॉगिन",
                dairyManagementSystem: "डेअरी व्यवस्थापन प्रणाली",
                email: "ईमेल",
                password: "पासवर्ड",
                login: "लॉगिन करा",
                rememberMe: "मला लक्षात ठेवा", // ✨ EXTRA
                newUser: "नवीन प्रशासक?",
                signupHere: "येथे साइन अप करा",
                newAdminAccount: "नवीन प्रशासक खाते",
                signup: "साइन अप करा",
                backToLogin: "लॉगिनवर परत जा",
                dairyAdmin: "डेअरी प्रशासक",
                logout: "लॉगआउट",
                adminId: "प्रशासक आयडी",
                cancel: "रद्द करा",
                confirm: "पुष्टी करा", // New
                switchToDark: "डार्क मोडवर स्विच करा", // New
                switchToLight: "लाइट मोडवर स्विच करा", // New
                
                // Navigation
                dashboard: "डॅशबोर्ड",
                customers: "ग्राहक",
                dailyLog: "दैनिक नोंद",
                fatLog: "फॅट लॉग", // New
                expenses: "खर्च",
                settings: "सेटिंग्ज",

                // Dashboard
                totalCustomers: "एकूण ग्राहक",
                totalBalance: "एकूण थकबाकी",
                monthlyExpenses: "या महिन्याचा खर्च",
                monthlyPayments: "जमा पेमेंट (महिना)", // New
                todayFat: "आजची फॅट",
                fatHistory: "फॅट इतिहास",
                getGeminiIncomeSummary: "मासिक उत्पन्न सारांश मिळवा (Gemini)", // New
                geminiIncomeSummaryTitle: "Gemini उत्पन्न सारांश", // New
                geminiIncomeLoading: "उत्पन्न सारांश तयार करत आहे...", // New
                geminiNoIncome: "सारांशासाठी या महिन्यात कोणतेही पेमेंट प्राप्त झाले नाही.", // New
                geminiIncomeSystemPrompt: "तुम्ही एक उपयुक्त डेअरी व्यवस्थापक सहाय्यक आहात. तुम्हाला मिळालेल्या पेमेंटची यादी दिली आहे. यावर आधारित, साधा मराठीत एक लहान (२-३ ओळी) सारांश द्या. एकूण उत्पन्न सांगा आणि किती पेमेंट मिळाले याचा उल्लेख करा.", // New
                geminiIncomeUserPrompt: "या महिन्यात मला मिळालेली पेमेंट खालीलप्रमाणे आहेत:\n{data}\n\nकृपया सारांश द्या.", // New

                // Customers Page
                manageCustomers: "ग्राहक व्यवस्थापित करा",
                addNewCustomer: "नवीन ग्राहक जोडा",
                addCustomer: "ग्राहक जोडा",
                customerList: "ग्राहकांची यादी",
                name: "नाव",
                milkType: "दुधाचा प्रकार",
                shift: "शिफ्ट",
                defaultQty: "डीफॉल्ट प्रमाण",
                balanceAmount: "थकबाकी",
                actions: "कृती",
                customerName: "ग्राहकाचे नाव",
                phoneNumber: "फोन नंबर",
                address: "पत्ता",
                defaultMilk: "डीफॉल्ट दूध (लिटर)",
                cowMilk: "गायीचे दूध",
                buffaloMilk: "म्हशीचे दूध",
                morningShift: "सकाळची शिफ्ट",
                eveningShift: "संध्याकाळची शिफ्ट",
                payment: "पेमेंट",
                history: "इतिहास",
                delete: "हटवा",
                phone: "फोन", // New
                address: "पत्ता", // New
                details: "तपशील", // New
                editCustomer: "ग्राहक संपादित करा", // ✨ New
                saveChanges: "बदल जतन करा", // ✨ New
                edit: "संपादित करा", // ✨ New

                // Daily Log
                todayDate: "आजची तारीख",
                cowMilkRate: "गायीच्या दुधाचा दर",
                buffaloMilkRate: "म्हशीच्या दुधाचा दर",
                setFromSettings: "सेटिंग्जमधून दर सेट करा",
                milkDelivered: "दूध दिले?",
                customer: "ग्राहक",
                quantityLiters: "प्रमाण (लिटर)",
                saveTodayLog: "आजची नोंद जतन करा",

                // Fat Log
                manageFatLog: "फॅट लॉग व्यवस्थापित करा",
                addFatEntry: "नवीन फॅट नोंद जोडा",
                fatValuePlaceholder: "फॅट व्हॅल्यू (उदा. ८.७)",
                addEntry: "नोंद जोडा",
                fatLogList: "फॅट लॉग यादी",
                date: "तारीख",
                fatValue: "फॅट व्हॅल्यू",
                
                // Expenses
                manageExpenses: "खर्च व्यवस्थापित करा",
                addNewExpense: "नवीन खर्च जोडा",
                expenseDescription: "खर्चाचा तपशील",
                amountPlaceholder: "रक्कम (₹)",
                addExpense: "खर्च जोडा",
                getGeminiSummary: "मासिक खर्चाचा सारांश मिळवा (Gemini)",
                expenseList: "खर्चाची यादी",
                description: "तपशील",
                amount: "रक्कम",
                
                // Settings
                setMilkRate: "दुधाचे दर सेट करा",
                milkRateExample: "उदा. ५०.५०",
                saveSettings: "सेटिंग्ज जतन करा",

                // Modals & Toasts
                receivePayment: "पेमेंट प्राप्त करा",
                currentBalance: "सध्याची थकबाकी",
                paymentAmount: "पेमेंट रक्कम (₹)",
                addPayment: "पेमेंट जोडा",
                geminiSummaryTitle: "Gemini खर्चाचा सारांश",
                geminiLoading: "Gemini कडून सारांश तयार करत आहे...",
                geminiNoExpenses: "या महिन्यात सारांश देण्यासाठी कोणताही खर्च आढळला नाही.",
                geminiError: "सारांश तयार करताना त्रुटी: ",
                geminiSystemPrompt: "तुम्ही एक उपयुक्त डेअरी व्यवस्थापक सहाय्यक आहात. तुम्हाला 'तारीख, तपशील, रक्कम' स्वरूपात खर्चाची यादी दिली आहे. यावर आधारित, साध्या मराठीत एक लहान (२-३ ओळी) सारांश द्या. एकूण खर्च सांगा आणि स्पष्ट असल्यास सर्वात मोठी खर्चाची श्रेणी सांगा.",
                geminiUserPrompt: "माझे या महिन्याचे खर्च खालीलप्रमाणे आहेत:\n{data}\n\nकृपया सारांश द्या.",
                
                // History Modal
                milkHistory: "दुधाचा इतिहास",
                paymentHistory: "पेमेंट इतिहास",
                status: "स्थिती",
                quantity: "प्रमाण",
                amountPaid: "दिलेली रक्कम",
                present: "हजर",
                absent: "गैरहजर",

                // Placeholders
                emailPlaceholder: "admin@email.com",
                passwordPlaceholder: "••••••••",

                // Errors & Success
                loginError: "लॉगिन करताना त्रुटी. कृपया ईमेल/पासवर्ड तपासा.",
                signupError: "साइन अप करताना त्रटी.",
                "auth/invalid-email": "अवैध ईमेल पत्ता.",
                "auth/user-not-found": "या ईमेलसह कोणताही प्रशासक आढळला नाही.",
                "auth/wrong-password": "चुकीचा पासवर्ड.",
                "auth/email-already-in-use": "हा ईमेल आधीच नोंदणीकृत आहे.",
                "auth/weak-password": "पासवर्ड किमान ६ अक्षरांचा असावा.",
                "auth/operation-not-allowed": "ईमेल/पासवर्ड लॉगिन सक्षम केलेले नाही. विकसकाशी संपर्क साधा.",
                error: "त्रुटी: ",
                settingsSaved: "सेटिंग्ज यशस्वीरित्या जतन केली!",
                customerAdded: "ग्राहक यशस्वीरित्या जोडला!",
                logSaved: "आजची नोंद यशस्वीरित्या जतन केली!",
                paymentAdded: "पेमेंट यशस्वीरित्या जोडले!",
                expenseAdded: "खर्च यशस्वीरित्या जोडला!",
                fatEntryAdded: "फॅट नोंद यशस्वीरित्या जोडली!", // New
                nameAndQtyRequired: "नाव आणि डीफॉल्ट प्रमाण आवश्यक आहे.",
                allFieldsRequired: "सर्व फील्ड आवश्यक आहेत.",
                milkRateRequired: "कृपया प्रथम सेटिंग्जमध्ये दुधाचे दर सेट करा!",
                noCustomersForLog: "ग्राहक आढळले नाहीत. प्रथम ग्राहक जोडा.",
                noExpenses: "अद्याप कोणताही खर्च नोंदवला नाही.",
                noFatLog: "अद्याप फॅट नोंदी नाहीत.", // New
                noMilkHistory: "या ग्राहकासाठी कोणताही दूध वितरण इतिहास आढळला नाही.",
                noPaymentHistory: "या ग्राहकासाठी कोणताही पेमेंट इतिहास आढळला नाही.",
                confirmDeleteCustomer: "तुम्हाला खात्री आहे की तुम्ही या ग्राहकाला हटवू इच्छिता? ही क्रिया पूर्ववत करता येणार नाही.",
                confirmDeleteExpense: "तुम्हाला खात्री आहे की तुम्ही हा खर्च हटवू इच्छिता?",
                confirmDeleteFat: "तुम्हाला खात्री आहे की तुम्ही ही फॅट नोंद हटवू इच्छिता?", // New
                customerAdded: "ग्राहक यशस्वीरित्या जोडला!",
                customerUpdated: "ग्राहकाचे तपशील अपडेट केले!", // ✨ New
                customerDeleted: "ग्राहक हटवला.",
                expenseDeleted: "खर्च हटवला.",
                fatLogDeleted: "फॅट नोंद हटवली.", // New
                confirmLogSaveTitle: "नोंद जतन करण्याची पुष्टी करा",
                confirmLogSaveText: "तुम्हाला खात्री आहे की तुम्ही आजची नोंद जतन करू इच्छिता? यामुळे ग्राहकांची थकबाकी अपडेट होईल.",

                // ✨ New: Chatbot
                geminiChatbot: "Lacto मदतनीस",
                chatWithGemini: "Lacto शी चॅट करा",
                typeYourQuestion: " तुमचा प्रश्न टाइप करा...",
                send: "पाठवा",
                geminiChatWelcome: "नमस्कार! मी Lacto, तुमचा सहाय्यक. मी आज अॅपमध्ये तुमची कशी मदत करू शकेन?",
                geminiThinking: "Lacto विचार करत आहे...",
                geminiChatSystemPrompt: "तुम्ही Lacto आहात, 'Doodh Dairy Management' वेब अॅपसाठी एक उपयुक्त सहाय्यक. एक प्रशासक तुम्हाला प्रश्न विचारत आहे. सोप्या, मैत्रीपूर्ण मराठीत थोडक्यात उत्तरे द्या. जर प्रश्न अॅपबद्दल असेल (उदा. 'ग्राहक कसे जोडावे?'), तर 'डॅशबोर्ड', 'ग्राहक', 'दैनिक नोंद', 'फॅट लॉग', 'खर्च', किंवा 'सेटिंग्ज' सारखी वैशिष्ट्ये कशी कार्य करतात हे स्पष्ट करा. जर तो सामान्य प्रश्न असेल (उदा. 'भारताची राजधानी कोणती?'), तर फक्त त्याचे उत्तर द्या.",
            } // 'mr' object ends here
        }; // 'translations' object ends here

        // ===== 3. DOM ELEMENT REFERENCES (Moved from various places) =====
        // Login/Signup
        const loginView = document.getElementById('login-view');
        const adminView = document.getElementById('admin-view');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupBtn = document.getElementById('show-signup-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        const authError = document.getElementById('auth-error');
        const rememberMe = document.getElementById('remember-me');

        // Sidebar/Nav
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('[data-page]');
        const adminUserId = document.getElementById('admin-user-id');
        const logoutBtn = document.getElementById('logout-btn');
        const langBtns = document.querySelectorAll('.lang-btn');

        // Dashboard
        const statTotalCustomers = document.getElementById('stat-total-customers');
        const statTotalBalance = document.getElementById('stat-total-balance');
        const statTotalExpenses = document.getElementById('stat-total-expenses');
        const statTotalPayments = document.getElementById('stat-total-payments');
        const getIncomeSummaryBtn = document.getElementById('get-income-summary-btn');
        const getExpenseSummaryBtnDash = document.getElementById('get-expense-summary-btn-dash');

        // Customers
        const addCustomerForm = document.getElementById('add-customer-form');
        const customerList = document.getElementById('customer-list');
        
        // Settings
        const settingsForm = document.getElementById('settings-form');
        const milkPriceCowInput = document.getElementById('milk-price-cow');
        const milkPriceBuffaloInput = document.getElementById('milk-price-buffalo');

        // Payment Modal
        const paymentModalBackdrop = document.getElementById('payment-modal-backdrop');
        const paymentModalContent = document.getElementById('payment-modal-content');
        const paymentForm = document.getElementById('payment-form');
        const cancelPaymentBtn = document.getElementById('cancel-payment-btn');
        
        // Gemini Modal
        const summaryModalBackdrop = document.getElementById('summary-modal-backdrop');
        const summaryModalContent = document.getElementById('summary-modal-content');
        const summaryModalTitle = document.getElementById('summary-modal-title');
        const closeSummaryBtn = document.getElementById('close-summary-btn');
        const summaryLoading = document.getElementById('summary-loading');
        const summaryResult = document.getElementById('summary-result');
        const getExpenseSummaryBtn = document.getElementById('get-expense-summary-btn');
        const summaryLoadingText = document.getElementById('summary-loading-text');


        // History Modal Elements
        const historyModalBackdrop = document.getElementById('history-modal-backdrop');
        const historyModalContent = document.getElementById('history-modal-content');
        const closeHistoryBtn = document.getElementById('close-history-btn');
        const historyCustomerName = document.getElementById('history-customer-name');
        const historyCustomerInfo = document.getElementById('history-customer-info');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const milkHistoryList = document.getElementById('milk-history-list');
        const noMilkHistory = document.getElementById('no-milk-history');
        const paymentHistoryList = document.getElementById('payment-history-list');
        const noPaymentHistory = document.getElementById('no-payment-history');
        // Unsubscriber variables for history modal listeners
        let milkLogUnsubscriber = null;
        let paymentLogUnsubscriber = null;

        // Custom Confirm Modal (New)
        const confirmModalBackdrop = document.getElementById('confirm-modal-backdrop');
        const confirmModalContent = document.getElementById('confirm-modal-content');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalBody = document.getElementById('confirm-modal-body');
        const confirmModalCancel = document.getElementById('confirm-modal-cancel');
        const confirmModalConfirm = document.getElementById('confirm-modal-confirm');
        
        // ✨ New: Edit Customer Modal Elements
        const editCustomerModalBackdrop = document.getElementById('edit-customer-modal-backdrop');
        const editCustomerModalContent = document.getElementById('edit-customer-modal-content');
        const editCustomerForm = document.getElementById('edit-customer-form');
        const cancelEditCustomerBtn = document.getElementById('cancel-edit-customer-btn');

        // ✨ New: Theme Toggle Elements
        const themeToggleBtn = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('theme-icon-sun');
        const moonIcon = document.getElementById('theme-icon-moon');
        const themeTextLight = document.getElementById('theme-text-light');
        const themeTextDark = document.getElementById('theme-text-dark');


        // ✨ New: Chatbot DOM Elements
        const chatbotFabWrapper = document.getElementById('chatbot-fab-wrapper');
        const chatbotFabBtn = document.getElementById('chatbot-fab-btn');
        const chatModalBackdrop = document.getElementById('chat-modal-backdrop');
        const chatModalContent = document.getElementById('chat-modal-content');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const chatHistory = document.getElementById('chat-history');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatLoading = document.getElementById('chat-loading');


        // ===== 3. LANGUAGE & HELPER FUNCTIONS =====
        let currentLanguage = 'en'; // Default language
        
        // Global state
        let currentAdminId = null;
        let milkPriceCow = 0;
        let milkPriceBuffalo = 0;
        let allFatData = []; // Cache for chart
        let fatChartInstance = null;
        
        // Global Firestore references
        let adminDocRef = null;
        let customerCollectionRef = null;
        let expenseCollectionRef = null;
        let fatLogCollectionRef = null;

        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('dairyLang', lang); // Save preference
            
            // Set <html> lang attribute
            document.documentElement.lang = lang === 'mr' ? 'mr' : 'en';

            // Update all elements with data-lang-key
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                el.textContent = t(key);
            });
            
            // Update all elements with data-lang-placeholder
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.dataset.langPlaceholder;
                el.placeholder = t(key);
            });
            
            // Update language buttons state
            langBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });

            // Update today's date format
            document.getElementById('today-date').textContent = new Date().toLocaleDateString(currentLanguage === 'mr' ? 'mr-IN' : 'en-IN');
        }

        langBtns.forEach(btn => {
            btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
        });

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            
            // Use translated message
            toastMessage.textContent = t(message); 
            
            if (isError) {
                toast.classList.remove('bg-green-600');
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.remove('bg-red-600');
                toast.classList.add('bg-green-600');
            }
            
            toast.classList.remove('hidden', 'translate-y-10', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR'
            }).format(amount);
        }

        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // New: Custom Confirm Modal
        let confirmCallback = null;
        function showConfirmModal(titleKey, bodyKey, onConfirm) {
            confirmModalTitle.textContent = t(titleKey);
            confirmModalBody.textContent = t(bodyKey);
            confirmCallback = onConfirm;
            
            // Set button color based on action (e.g., delete)
            if (titleKey.includes('Delete')) {
                confirmModalConfirm.classList.remove('bg-green-600', 'hover:bg-green-700');
                confirmModalConfirm.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                confirmModalConfirm.classList.remove('bg-red-600', 'hover:bg-red-700');
                confirmModalConfirm.classList.add('bg-green-600', 'hover:bg-green-700');
            }
            
            confirmModalBackdrop.classList.add('active');
            confirmModalContent.classList.add('active');
        }
        
        function closeConfirmModal() {
            confirmModalBackdrop.classList.remove('active');
            confirmModalContent.classList.remove('active');
            confirmCallback = null;
        }
        
        confirmModalCancel.addEventListener('click', closeConfirmModal);
        confirmModalBackdrop.addEventListener('click', closeConfirmModal);
        confirmModalConfirm.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        });


        // ✨ New: Apply Remote Config (Updated Logic)
        function applyRemoteConfig() {
            // Get boolean values
            const showExpenses = getBoolean(remoteConfig, "show_expenses_manager");
            const showLanguage = getBoolean(remoteConfig, "show_language_switcher");
            const showGemini = getBoolean(remoteConfig, "show_gemini_summary");
            const showChatbot = getBoolean(remoteConfig, "show_gemini_chatbot"); // ✨ New
            const showThemeToggle = getBoolean(remoteConfig, "show_theme_toggle"); // ✨ New
            const showLogoutButton = getBoolean(remoteConfig, "show_logout_button"); // ✨ New

            // Get string values
            const bgColor = getString(remoteConfig, "app_background_color");
            const bgImageUrl = getString(remoteConfig, "app_background_image_url"); // ✨ New

            // ✨ FIX: Add console.logs to show fetched values
            console.log("Applying Remote Config values...");
            console.log(`- show_expenses_manager: ${showExpenses}`);
            console.log(`- show_language_switcher: ${showLanguage}`);
            console.log(`- show_gemini_summary: ${showGemini}`);
            console.log(`- app_background_color: ${bgColor}`);
            console.log(`- app_background_image_url: ${bgImageUrl}`); // ✨ New
            console.log(`- show_gemini_chatbot: ${showChatbot}`); // ✨ New
            console.log(`- show_theme_toggle: ${showThemeToggle}`); // ✨ New
            console.log(`- show_logout_button: ${showLogoutButton}`); // ✨ New

            // Apply to UI
            document.getElementById('nav-expenses-wrapper').style.display = showExpenses ? 'block' : 'none';
            document.getElementById('language-switcher-wrapper').style.display = showLanguage ? 'block' : 'none';
            document.getElementById('gemini-summary-wrapper').style.display = showGemini ? 'grid' : 'none';
            document.getElementById('gemini-expense-btn-wrapper').style.display = showGemini ? 'block' : 'none';
            document.getElementById('chatbot-fab-wrapper').style.display = showChatbot ? 'block' : 'none'; // ✨ New
            document.getElementById('theme-toggle-wrapper').style.display = showThemeToggle ? 'block' : 'none'; // ✨ New
            document.getElementById('logout-btn-wrapper').style.display = showLogoutButton ? 'block' : 'none'; // ✨ New

            // ✨ New: Apply background to "Whole App" (Login View + Admin View Wrapper)
            const loginViewEl = document.getElementById('login-view');
            const adminViewWrapper = document.getElementById('admin-view-wrapper');
            const mainContent = document.getElementById('main-content'); // Get this to *remove* old logic

            // Reset old logic from main-content
            if (mainContent) {
                mainContent.style.backgroundColor = '';
            }

            const containers = [loginViewEl, adminViewWrapper].filter(Boolean); // Get valid containers

            if (bgImageUrl && bgImageUrl.trim() !== "") {
                // Image URL is present, use it
                const bgStyle = `url('${bgImageUrl}') no-repeat center center fixed`;
                containers.forEach(container => {
                    container.style.background = bgStyle;
                    container.style.backgroundSize = 'cover';
                });
            } else if (bgColor && bgColor.trim() !== "") {
                // No image, but color is present
                containers.forEach(container => {
                    container.style.background = bgColor; // Set color
                    container.style.backgroundSize = ''; // Unset size
                });
            } else {
                // No image or color, reset to CSS defaults
                containers.forEach(container => {
                    container.style.background = ''; // Resets to CSS
                    container.style.backgroundSize = '';
                });
            }
        }


        function initAppLogic() {
            // Fetch and apply Remote Config first
            fetchAndActivate(remoteConfig)
                .then(() => {
                    applyRemoteConfig();
                    console.log("Remote Config fetched and activated.");
                })
                .catch((err) => {
                    console.error('Remote Config fetch failed', err);
                    applyRemoteConfig(); // Apply defaults even if fetch fails
                })
                .finally(() => {
                    // Start listening to data AFTER config is applied
                    listenToSettings();
                    listenToCustomers();
                    listenToExpenses();
                    listenToFatLog();
                    loadDashboardStats(); 
                    document.getElementById('today-date').textContent = new Date().toLocaleDateString(currentLanguage === 'mr' ? 'mr-IN' : 'en-IN');
                    document.getElementById('fat-date').value = getTodayDateString(); // Set fat date on init
                    setLanguage(localStorage.getItem('dairyLang') || 'en');
                    setupChartFilterButtons();
                    setupEditCustomerModal(); // ✨ New: Setup edit modal listeners
                    setupChatbot(); // ✨ New: Setup chatbot listeners
                });
        }
        

        // ===== 4. AUTHENTICATION =====
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                currentAdminId = user.uid;
                adminUserId.textContent = user.uid;
                
                // Initialize Firestore references
                adminDocRef = doc(db, 'dairyAdmins', currentAdminId);
                customerCollectionRef = collection(db, adminDocRef.path, 'customers');
                expenseCollectionRef = collection(db, adminDocRef.path, 'expenses');
                fatLogCollectionRef = collection(db, adminDocRef.path, 'fatLog'); // New
                
                // Show admin view, hide login view
                adminView.classList.remove('hidden');
                loginView.classList.add('hidden');
                
                // Start the app logic
                initAppLogic();
                
            } else {
                // User is signed out
                currentAdminId = null;
                // Show login view, hide admin view
                loginView.classList.remove('hidden');
                adminView.classList.add('hidden');

                // Clear any sensitive data if needed (e.g., clear lists)
                customerList.innerHTML = '';
                expenseList.innerHTML = '';
                dailyLogList.innerHTML = '';
                fatLogList.innerHTML = '';
            }
        });

        // ✨ New: Theme Toggle Logic
        function initTheme() {
            const isDark = localStorage.getItem('dairyTheme') === 'dark';
            document.documentElement.classList.toggle('dark', isDark);
            updateThemeButton(isDark);
        }
        function updateThemeButton(isDark) {
            sunIcon.classList.toggle('hidden', !isDark);
            moonIcon.classList.toggle('hidden', isDark);
            themeTextLight.classList.toggle('hidden', isDark);
            themeTextDark.classList.toggle('hidden', !isDark);
            // Update chart if it exists
            if (fatChartInstance) {
                const activeFilter = document.querySelector('.fat-filter-btn.active');
                const days = activeFilter ? parseInt(activeFilter.dataset.days) : 7;
                updateFatChart(days);
            }
        }
        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('dairyTheme', isDark ? 'dark' : 'light');
            updateThemeButton(isDark);
        });
        initTheme(); // Apply theme on load
        

        // ===== 5. NAVIGATION =====
        function setupNavigation() {
            // Mobile menu toggle
            menuToggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            });
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });
            
            // Page navigation
            function showPage(hash) {
                const pageId = (hash || '#dashboard').substring(1) + '-page';
                
                pages.forEach(page => {
                    page.classList.toggle('active', page.id === pageId);
                });
                
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.getAttribute('href') === hash);
                });
                
                // Close mobile sidebar on nav click
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
                
                // Update header title (if needed, or just keep it static)
            }

            // Handle nav link clicks
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const hash = new URL(link.href).hash;
                    window.location.hash = hash; // This triggers 'hashchange'
                });
            });

            // Handle hash changes (page loads, back button)
            window.addEventListener('hashchange', () => showPage(window.location.hash));
            // Show initial page
            showPage(window.location.hash || '#dashboard');
        }
        setupNavigation();


        // ===== 6. DASHBOARD =====
        async function loadDashboardStats() {
            if (!adminDocRef || !customerCollectionRef || !expenseCollectionRef) return;
            
            // 1. Total Customers
            const customersSnapshot = await getDocs(customerCollectionRef);
            statTotalCustomers.textContent = customersSnapshot.size;
            
            // 2. Total Balance
            let totalBalance = 0;
            customersSnapshot.forEach(doc => {
                totalBalance += doc.data().currentBalance || 0;
            });
            statTotalBalance.textContent = formatCurrency(totalBalance);
            
            // 3. This Month's Expenses
            const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            const firstDayOfMonthString = getTodayDateString().substring(0, 8) + '01'; // YYYY-MM-01
            
            // ✨ FIX: Remove orderBy, filter in JS
            const expenses = [];
            const q = query(expenseCollectionRef);
            const querySnapshot = await getDocs(q);

            querySnapshot.forEach(doc => {
                expenses.push(doc.data());
            });

            const thisMonthExpenses = expenses.filter(ex => ex.date >= firstDayOfMonthString);
            
            let totalExpenses = 0;
            thisMonthExpenses.forEach(ex => {
                totalExpenses += ex.amount;
            });
            statTotalExpenses.textContent = formatCurrency(totalExpenses);

            // 4. This Month's Payments (New)
            let totalPayments = 0;
            // Use collectionGroup query to find all 'paymentLog' entries for this admin
            // NOTE: This requires a Firestore index.
            try {
                const paymentLogsQuery = query(collectionGroup(db, 'paymentLog'));
                // Cannot query collectionGroup with adminId directly without composite index.
                // We must iterate over customers instead.
                
                for (const customerDoc of customersSnapshot.docs) {
                    const paymentLogCol = collection(db, customerDoc.ref.path, 'paymentLog');
                    // ✨ FIX: Remove orderBy
                    const paymentQuery = query(paymentLogCol);
                    const paymentSnapshot = await getDocs(paymentQuery);
                    
                    paymentSnapshot.forEach(paymentDoc => {
                        const payment = paymentDoc.data();
                        // Filter for this month in JS
                        if (payment.date && new Date(payment.date) >= firstDayOfMonth) {
                            totalPayments += payment.amount;
                        }
                    });
                }
                statTotalPayments.textContent = formatCurrency(totalPayments);
                
            } catch (error) {
                 console.error("Error calculating total payments (this may be an index issue):", error.message);
                 statTotalPayments.textContent = "Error";
            }
        }

        // ===== 7. SETTINGS =====
        function listenToSettings() {
            if (!adminDocRef) return;
            onSnapshot(adminDocRef, (doc) => {
                if (doc.exists()) {
                    const settings = doc.data();
                    milkPriceCow = settings.milkPriceCow || 0;
                    milkPriceBuffalo = settings.milkPriceBuffalo || 0;
                    
                    // Update settings page
                    milkPriceCowInput.value = milkPriceCow;
                    milkPriceBuffaloInput.value = milkPriceBuffalo;
                    
                    // Update daily log page
                    document.getElementById('log-cow-milk-price').textContent = `${formatCurrency(milkPriceCow)}/L`;
                    document.getElementById('log-buffalo-milk-price').textContent = `${formatCurrency(milkPriceBuffalo)}/L`;
                } else {
                    console.log("No settings doc, creating one.");
                    // Optional: Create a default settings doc if it doesn't exist
                    setDoc(adminDocRef, { milkPriceCow: 0, milkPriceBuffalo: 0 });
                }
            });
        }
        
        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const priceCow = parseFloat(milkPriceCowInput.value);
            const priceBuffalo = parseFloat(milkPriceBuffaloInput.value);
            
            try {
                await setDoc(adminDocRef, { 
                    milkPriceCow: priceCow, 
                    milkPriceBuffalo: priceBuffalo 
                }, { merge: true });
                showToast("settingsSaved");
            } catch (error) {
                showToast(t("error") + error.message, true);
            }
        });

        // ===== 8. CUSTOMERS =====
        function listenToCustomers() {
            if (!customerCollectionRef) return;
            // ✨ FIX: Remove orderBy, add client-side sort
            const q = query(customerCollectionRef);
            onSnapshot(q, (snapshot) => {
                const customers = [];
                snapshot.forEach(doc => {
                    customers.push({ id: doc.id, ...doc.data() });
                });
                // ✨ FIX: Sort in JS
                customers.sort((a, b) => a.name.localeCompare(b.name));
                
                renderCustomerList(customers);
                renderDailyLog(customers); // Update daily log page
            });
        }
        
        addCustomerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('customer-name').value;
            const phone = document.getElementById('customer-phone').value;
            const address = document.getElementById('customer-address').value;
            const defaultQty = parseFloat(document.getElementById('customer-qty').value);
            const milkType = document.getElementById('customer-milk-type').value;
            const shift = document.getElementById('customer-shift').value;
            
            if (!name || isNaN(defaultQty) || defaultQty < 0) {
                showToast("nameAndQtyRequired", true);
                return;
            }
            
            try {
                await addDoc(customerCollectionRef, {
                    name,
                    phone,
                    address,
                    defaultQty,
                    milkType,
                    shift,
                    currentBalance: 0,
                    createdAt: Timestamp.now(),
                    adminId: currentAdminId // Add adminId
                });
                showToast("customerAdded");
                addCustomerForm.reset();
            } catch (error) {
                showToast(t("error") + error.message, true);
            }
        });

        function renderCustomerList(customers) {
            customerList.innerHTML = ''; 
            if (customers.length === 0) {
                customerList.innerHTML = `<tr><td colspan="6" class="text-center p-6 text-gray-500 dark:text-gray-400">${t("noCustomersForLog")}</td></tr>`;
                return;
            }
            
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                
                // Handle missing fields gracefully for history button
                const customerData = {
                    id: customer.id,
                    name: customer.name,
                    phone: customer.phone || '',
                    address: customer.address || '',
                    defaultQty: customer.defaultQty,
                    milkType: customer.milkType,
                    shift: customer.shift
                };
                const customerDataString = JSON.stringify(customerData).replace(/'/g, "\\'");
                const milkTypeDisplay = t(customer.milkType);
                const shiftDisplay = t(customer.shift);

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="#" class="btn-history text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline" data-id="${customer.id}" data-customer-json='${customerDataString}'>${customer.name}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${milkTypeDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${shiftDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${customer.defaultQty} L</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${customer.currentBalance > 0 ? 'text-red-600 dark:text-red-400' : 'text-gray-800 dark:text-gray-200'}">
                        ${formatCurrency(customer.currentBalance)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button data-id="${customer.id}" data-name="${customer.name}" data-balance="${customer.currentBalance}" class="btn-payment px-3 py-1 bg-green-100 text-green-700 rounded-md hover:bg-green-200 dark:bg-green-800 dark:text-green-200 dark:hover:bg-green-700 transition-colors" title="${t('payment')}">
                            <i class="fas fa-receipt"></i>
                        </button>
                        <!-- ✨ New: Edit Customer Button -->
                        <button data-id="${customer.id}" data-customer-json='${customerDataString}' class="btn-edit px-3 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 dark:bg-blue-800 dark:text-blue-200 dark:hover:bg-blue-700 transition-colors" title="${t('edit')}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button data-id="${customer.id}" class="btn-delete px-3 py-1 bg-red-100 text-red-700 rounded-md hover:bg-red-200 dark:bg-red-800 dark:text-red-200 dark:hover:bg-red-700 transition-colors" title="${t('delete')}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                customerList.appendChild(row);
            });
        }


        // ===== 9. EVENT LISTENERS (LOGIN, LOGOUT, CUSTOMER ACTIONS) =====
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const remember = rememberMe.checked; // ✨ EXTRA

            try {
                // ✨ EXTRA: Set persistence
                const persistence = remember ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistence);
                
                await signInWithEmailAndPassword(auth, email, password);
                // On success, onAuthStateChanged will handle the UI switch
            } catch (error) {
                authError.textContent = t(error.code) || t("loginError");
            }
        });
        
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // On success, onAuthStateChanged will handle the UI switch
            } catch (error) {
                authError.textContent = t(error.code) || t("signupError");
            }
        });
        
        showSignupBtn.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            authError.textContent = '';
        });
        
        showLoginBtn.addEventListener('click', () => {
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            authError.textContent = '';
        });
        
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            // onAuthStateChanged will handle UI switch
        });
        
        // Customer list actions (Payment, History, Delete)
        customerList.addEventListener('click', (e) => {
            const target = e.target.closest('button, a'); // Listen for buttons or links
            if (!target) return;
            
            if (target.classList.contains('btn-delete')) {
                const customerId = target.dataset.id;
                // Use new confirm modal
                showConfirmModal("confirmDeleteCustomer", "confirmDeleteCustomer", async () => {
                    try {
                        await deleteDoc(doc(customerCollectionRef, customerId));
                        showToast("customerDeleted");
                    } catch (error) {
                        showToast(t("error") + error.message, true);
                    }
                });
            }
            
            if (target.classList.contains('btn-payment')) {
                const customerId = target.dataset.id;
                const customerName = target.dataset.name;
                const currentBalance = parseFloat(target.dataset.balance);
                
                document.getElementById('payment-customer-id').value = customerId;
                document.getElementById('payment-customer-name').textContent = customerName;
                document.getElementById('payment-customer-balance').textContent = formatCurrency(currentBalance);
                document.getElementById('payment-amount').value = currentBalance > 0 ? currentBalance.toFixed(2) : ''; // Pre-fill amount
                
                paymentModalBackdrop.classList.add('active');
                paymentModalContent.classList.add('active');
            }

            if (target.classList.contains('btn-history')) {
                const customer = JSON.parse(target.dataset.customerJson);
                openHistoryModal(customer);
            }

            // ✨ New: Handle Edit Customer Button
            if (target.classList.contains('btn-edit')) {
                const customer = JSON.parse(target.dataset.customerJson);
                openEditCustomerModal(customer);
            }
        });

        // ===== 10. PAYMENT MODAL =====
        cancelPaymentBtn.addEventListener('click', () => {
            paymentModalBackdrop.classList.remove('active');
            paymentModalContent.classList.remove('active');
            paymentForm.reset();
        });
        paymentModalBackdrop.addEventListener('click', () => {
            paymentModalBackdrop.classList.remove('active');
            paymentModalContent.classList.remove('active');
            paymentForm.reset();
        });
        
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const customerId = document.getElementById('payment-customer-id').value;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            
            if (isNaN(amount) || amount <= 0) {
                showToast("allFieldsRequired", true);
                return;
            }
            
            const customerDocRef = doc(customerCollectionRef, customerId);
            const paymentLogDocRef = doc(collection(db, customerDocRef.path, 'paymentLog'));
            
            try {
                const batch = writeBatch(db);
                
                // 1. Update customer balance
                batch.update(customerDocRef, { currentBalance: increment(-amount) });
                
                // 2. Add to paymentLog subcollection
                batch.set(paymentLogDocRef, {
                    date: getTodayDateString(),
                    amount: amount,
                    createdAt: Timestamp.now(),
                    adminId: currentAdminId // Add adminId
                });
                
                await batch.commit();
                showToast("paymentAdded");
                paymentModalBackdrop.classList.remove('active');
                paymentModalContent.classList.remove('active');
                paymentForm.reset();
            } catch (error) {
                showToast(t("error") + error.message, true);
            }
        });

        // ✨ ===== New: 10.5 EDIT CUSTOMER MODAL =====
        function openEditCustomerModal(customer) {
            // Pre-fill the form
            document.getElementById('edit-customer-id').value = customer.id;
            document.getElementById('edit-customer-name').value = customer.name;
            document.getElementById('edit-customer-phone').value = customer.phone || '';
            document.getElementById('edit-customer-address').value = customer.address || '';
            document.getElementById('edit-customer-qty').value = customer.defaultQty;
            document.getElementById('edit-customer-milk-type').value = customer.milkType;
            document.getElementById('edit-customer-shift').value = customer.shift;
            
            // Show the modal
            editCustomerModalBackdrop.classList.add('active');
            editCustomerModalContent.classList.add('active');
        }

        function closeEditCustomerModal() {
            editCustomerModalBackdrop.classList.remove('active');
            editCustomerModalContent.classList.remove('active');
            editCustomerForm.reset();
        }

        function setupEditCustomerModal() {
            cancelEditCustomerBtn.addEventListener('click', closeEditCustomerModal);
            editCustomerModalBackdrop.addEventListener('click', closeEditCustomerModal);

            editCustomerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const customerId = document.getElementById('edit-customer-id').value;
                const name = document.getElementById('edit-customer-name').value;
                const phone = document.getElementById('edit-customer-phone').value;
                const address = document.getElementById('edit-customer-address').value;
                const defaultQty = parseFloat(document.getElementById('edit-customer-qty').value);
                const milkType = document.getElementById('edit-customer-milk-type').value;
                const shift = document.getElementById('edit-customer-shift').value;

                if (!name || isNaN(defaultQty) || defaultQty < 0) {
                    showToast("nameAndQtyRequired", true);
                    return;
                }

                try {
                    const customerDocRef = doc(customerCollectionRef, customerId);
                    await updateDoc(customerDocRef, {
                        name,
                        phone,
                        address,
                        defaultQty,
                        milkType,
                        shift
                    });
                    showToast("customerUpdated");
                    closeEditCustomerModal();
                } catch (error) {
                    showToast(t("error") + error.message, true);
                }
            });
        }


        // ===== 11. DAILY LOG =====
        const dailyLogList = document.getElementById('daily-log-list');
        const dailyLogForm = document.getElementById('daily-log-form');

        function renderDailyLog(customers) {
            dailyLogList.innerHTML = ''; 
            if (customers.length === 0) {
                dailyLogList.innerHTML = `<tr><td colspan="3" class="text-center p-6 text-gray-500 dark:text-gray-400">${t("noCustomersForLog")}</td></tr>`;
                return;
            }

            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <input type="checkbox" data-id="${customer.id}" data-milk-type="${customer.milkType}" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 log-checkbox">
                    </td>
                    <td class="px-6 py-4">
                        <label class="text-sm font-medium text-gray-900 dark:text-gray-100">${customer.name} (${t(customer.shift)} - ${t(customer.milkType)})</label>
                    </td>
                    <td class="px-6 py-4">
                        <input type="number" step="0.5" min="0" value="${customer.defaultQty}" class="log-qty p-1 border rounded-md w-24 dark:bg-gray-700 dark:border-gray-600" disabled>
                    </td>
                `;
                dailyLogList.appendChild(row);
            });
            
            dailyLogList.querySelectorAll('.log-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const qtyInput = e.target.closest('tr').querySelector('.log-qty');
                    qtyInput.disabled = !e.target.checked;
                });
            });
        }
        
        dailyLogForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (milkPriceCow <= 0 || milkPriceBuffalo <= 0) {
                showToast("milkRateRequired", true);
                return;
            }
            
            // Use new confirm modal
            showConfirmModal("confirmLogSaveTitle", "confirmLogSaveText", async () => {
                const batch = writeBatch(db);
                const allRows = dailyLogList.querySelectorAll('tbody tr');
                const today = getTodayDateString();
                
                allRows.forEach(row => {
                    const checkbox = row.querySelector('.log-checkbox');
                    if (!checkbox) return;
                    
                    const customerId = checkbox.dataset.id;
                    const milkType = checkbox.dataset.milkType; // Get milk type
                    const customerDocRef = doc(customerCollectionRef, customerId);
                    const milkLogDocRef = doc(collection(db, customerDocRef.path, 'milkLog'));
                    
                    if (checkbox.checked) {
                        const qty = parseFloat(row.querySelector('.log-qty').value);
                        if (qty > 0) {
                            // Use correct price based on milk type
                            const price = milkType === 'cow' ? milkPriceCow : milkPriceBuffalo;
                            const amountToBeAdded = qty * price;
                            
                            batch.update(customerDocRef, { currentBalance: increment(amountToBeAdded) });
                            batch.set(milkLogDocRef, {
                                date: today,
                                status: 'present',
                                qty: qty,
                                amount: amountToBeAdded,
                                createdAt: Timestamp.now(),
                                adminId: currentAdminId // Add adminId
                            });
                        }
                    } else {
                        batch.set(milkLogDocRef, {
                            date: today,
                            status: 'absent',
                            qty: 0,
                            amount: 0,
                            createdAt: Timestamp.now(),
                            adminId: currentAdminId // Add adminId
                        });
                    }
                });
                
                try {
                    await batch.commit();
                    showToast("logSaved");
                    dailyLogList.querySelectorAll('.log-checkbox:checked').forEach(cb => {
                        cb.checked = false;
                        cb.closest('tr').querySelector('.log-qty').disabled = true;
                    });
                } catch (error) {
                    showToast(t("error") + error.message, true);
                }
            });
        });

        // ===== 12. EXPENSES =====
        const addExpenseForm = document.getElementById('add-expense-form');
        const expenseList = document.getElementById('expense-list');
        
        addExpenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('expense-date').value;
            const description = document.getElementById('expense-desc').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            
            if (!date || !description || isNaN(amount) || amount <= 0) {
                showToast("allFieldsRequired", true);
                return;
            }
            
            try {
                await addDoc(expenseCollectionRef, {
                    date, description, amount,
                    createdAt: Timestamp.now(),
                    adminId: currentAdminId // Add adminId
                });
                showToast("expenseAdded");
                addExpenseForm.reset();
            } catch (error) {
                showToast(t("error") + error.message, true);
            }
        });

        expenseList.addEventListener('click', async (e) => {
            const target = e.target.closest('.btn-delete-expense');
            if (!target) return;
            
            const expenseId = target.dataset.id;
            
            // Use new confirm modal
            showConfirmModal("confirmDeleteExpense", "confirmDeleteExpense", async () => {
                try {
                    await deleteDoc(doc(expenseCollectionRef, expenseId));
                    showToast("expenseDeleted");
                } catch (error) {
                    showToast(t("error") + error.message, true);
                }
            });
        });

        function listenToExpenses() {
            if (!expenseCollectionRef) return;
            // ✨ FIX: Remove orderBy, add client-side sort
            const q = query(expenseCollectionRef);
            onSnapshot(q, (snapshot) => {
                const expenses = [];
                snapshot.forEach(doc => {
                    expenses.push({ id: doc.id, ...doc.data() });
                });
                // Sort in JS
                expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderExpenseList(expenses);
            });
        }
        
        function renderExpenseList(expenses) {
            expenseList.innerHTML = ''; 
            if (expenses.length === 0) {
                expenseList.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-gray-500 dark:text-gray-400">${t("noExpenses")}</td></tr>`;
                return;
            }
            
            expenses.forEach(expense => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${expense.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${expense.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800 dark:text-gray-200">${formatCurrency(expense.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-id="${expense.id}" class="btn-delete-expense px-3 py-1 bg-red-100 text-red-700 rounded-md hover:bg-red-200 dark:bg-red-800 dark:text-red-200 dark:hover:bg-red-700 transition-colors" title="${t('delete')}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                expenseList.appendChild(row);
            });
        }


        // ===== 13. GEMINI API FUNCTIONS =====

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function callGeminiApi(payload, retries = 5, delay = 1000) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid response structure from Gemini API.");
                    }
                } catch (error) {
                    console.warn(`Gemini API call failed (attempt ${i + 1}):`, error.message);
                    if (i === retries - 1) throw error; 
                    await sleep(delay);
                    delay *= 2; 
                }
            }
        }

        async function handleExpenseSummary() {
            // ✨ New: Update modal title
            summaryModalTitle.textContent = t('geminiSummaryTitle');
            summaryLoadingText.textContent = t('geminiLoading');
            summaryLoading.style.display = 'block';
            summaryResult.style.display = 'none';
            summaryResult.textContent = '';
            summaryModalBackdrop.classList.add('active');
            summaryModalContent.classList.add('active');

            try {
                const firstDayOfMonthString = getTodayDateString().substring(0, 8) + '01'; // YYYY-MM-01
                
                // ✨ FIX: Remove orderBy, filter in JS
                const expenses = [];
                const q = query(expenseCollectionRef);
                const querySnapshot = await getDocs(q);

                querySnapshot.forEach(doc => {
                    expenses.push(doc.data());
                });

                const thisMonthExpenses = expenses.filter(ex => ex.date >= firstDayOfMonthString);

                if (thisMonthExpenses.length === 0) {
                    summaryResult.textContent = t("geminiNoExpenses");
                    summaryLoading.style.display = 'none';
                    summaryResult.style.display = 'block';
                    return;
                }

                const expensePromptData = thisMonthExpenses.map(ex => `Taarikh: ${ex.date}, Vivaran: ${ex.description}, Raashi: ${formatCurrency(ex.amount)}`).join('\n');
                const systemPrompt = t("geminiSystemPrompt");
                const userPrompt = t("geminiUserPrompt").replace('{data}', expensePromptData);

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const summaryText = await callGeminiApi(payload);

                summaryResult.textContent = summaryText;
                summaryLoading.style.display = 'none';
                summaryResult.style.display = 'block';

            } catch (error) {
                summaryResult.textContent = t("geminiError") + error.message;
                summaryLoading.style.display = 'none';
                summaryResult.style.display = 'block';
            }
        }

        // ✨ New: Gemini Income Summary
        async function handleIncomeSummary() {
            summaryModalTitle.textContent = t('geminiIncomeSummaryTitle');
            summaryLoadingText.textContent = t('geminiIncomeLoading');
            summaryLoading.style.display = 'block';
            summaryResult.style.display = 'none';
            summaryResult.textContent = '';
            summaryModalBackdrop.classList.add('active');
            summaryModalContent.classList.add('active');

            try {
                const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                let payments = [];
                
                // This is complex. We must iterate over customers, then their paymentLogs
                const customerSnapshot = await getDocs(customerCollectionRef);
                for (const customerDoc of customerSnapshot.docs) {
                    const paymentLogCol = collection(db, customerDoc.ref.path, 'paymentLog');
                    // ✨ FIX: Remove orderBy
                    const paymentQuery = query(paymentLogCol);
                    const paymentSnapshot = await getDocs(paymentQuery);
                    
                    paymentSnapshot.forEach(paymentDoc => {
                        const payment = paymentDoc.data();
                        // Filter for this month in JS
                        if (payment.date && new Date(payment.date) >= firstDayOfMonth) {
                            payments.push(payment);
                        }
                    });
                }
                
                if (payments.length === 0) {
                    summaryResult.textContent = t("geminiNoIncome");
                    summaryLoading.style.display = 'none';
                    summaryResult.style.display = 'block';
                    return;
                }

                const incomePromptData = payments.map(p => `Taarikh: ${p.date}, Raashi: ${formatCurrency(p.amount)}`).join('\n');
                const systemPrompt = t("geminiIncomeSystemPrompt");
                const userPrompt = t("geminiIncomeUserPrompt").replace('{data}', incomePromptData);

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const summaryText = await callGeminiApi(payload);
                summaryResult.textContent = summaryText;
                
            } catch (error) {
                console.error("Income Summary Error:", error);
                summaryResult.textContent = t("geminiError") + error.message;
            } finally {
                summaryLoading.style.display = 'none';
                summaryResult.style.display = 'block';
            }
        }
        
        getExpenseSummaryBtn.addEventListener('click', handleExpenseSummary);
        getExpenseSummaryBtnDash.addEventListener('click', handleExpenseSummary);
        getIncomeSummaryBtn.addEventListener('click', handleIncomeSummary);
        
        function closeSummaryModal() {
            summaryModalBackdrop.classList.remove('active');
            summaryModalContent.classList.remove('active');
        }
        closeSummaryBtn.addEventListener('click', closeSummaryModal);
        summaryModalBackdrop.addEventListener('click', closeSummaryModal);

        // ===== 14. CUSTOMER HISTORY MODAL =====
        
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetTab = btn.dataset.tab;
                
                tabButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === `${targetTab}-content`);
                });
            });
        });

        async function openHistoryModal(customer) { // Updated to accept full customer object
            if (milkLogUnsubscriber) milkLogUnsubscriber();
            if (paymentLogUnsubscriber) paymentLogUnsubscriber();

            document.querySelector('.tab-btn[data-tab="milk-history"]').click();
            
            historyModalBackdrop.classList.add('active');
            historyModalContent.classList.add('active');

            // New: Populate customer details
            historyCustomerName.textContent = customer.name;
            historyCustomerInfo.innerHTML = `
                <p class="flex items-center"><i class="fas fa-phone w-4 mr-2"></i> ${customer.phone || 'N/A'}</p>
                <p class="flex items-center mt-1"><i class="fas fa-map-marker-alt w-4 mr-2"></i> ${customer.address || 'N/A'}</p>
                <p class="mt-2"><strong data-lang-key="details" class="dark:text-gray-100">${t('details')}</strong>: 
                    ${customer.defaultQty}L, ${t(customer.milkType)}, ${t(customer.shift)}
                </p>
            `;

            const customerId = customer.id;
            // --- Load Milk History ---
            const milkLogCol = collection(db, customerCollectionRef.path, customerId, 'milkLog');
            // ✨ FIX: Remove orderBy
            const milkQuery = query(milkLogCol);
            
            milkLogUnsubscriber = onSnapshot(milkQuery, (snapshot) => {
                const milkHistory = [];
                snapshot.forEach(doc => {
                    milkHistory.push({ id: doc.id, ...doc.data() });
                });
                // ✨ FIX: Sort in JS
                milkHistory.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

                milkHistoryList.innerHTML = '';
                if (milkHistory.length === 0) {
                    noMilkHistory.style.display = 'block';
                    noMilkHistory.textContent = t('noMilkHistory');
                    return;
                }
                noMilkHistory.style.display = 'none';
                milkHistory.forEach(log => {
                    const statusClass = log.status === 'present' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                    const statusText = log.status === 'present' ? t('present') : t('absent');
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">${log.date}</td>
                        <td class="px-4 py-3 text-sm font-medium ${statusClass}">${statusText}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">${log.qty} L</td>
                        <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">${formatCurrency(log.amount)}</td>
                    `;
                    milkHistoryList.appendChild(row);
                });
            }, (error) => {
                 console.error("Error listening to milk history: ", error.message);
                 milkHistoryList.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-500">${error.message}</td></tr>`;
            });

            // --- Load Payment History ---
            const paymentLogCol = collection(db, customerCollectionRef.path, customerId, 'paymentLog');
            // ✨ FIX: Remove orderBy
            const paymentQuery = query(paymentLogCol);
            
            paymentLogUnsubscriber = onSnapshot(paymentQuery, (snapshot) => {
                const paymentHistory = [];
                snapshot.forEach(doc => {
                    paymentHistory.push({ id: doc.id, ...doc.data() });
                });
                // ✨ FIX: Sort in JS
                paymentHistory.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

                paymentHistoryList.innerHTML = '';
                if (paymentHistory.length === 0) {
                    noPaymentHistory.style.display = 'block';
                    noPaymentHistory.textContent = t('noPaymentHistory');
                    return;
                }
                noPaymentHistory.style.display = 'none';
                paymentHistory.forEach(log => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">${log.date}</td>
                        <td class="px-4 py-3 text-sm font-semibold text-green-700 dark:text-green-400">${formatCurrency(log.amount)}</td>
                    `;
                    paymentHistoryList.appendChild(row);
                });
            }, (error) => {
                console.error("Error listening to payment history: ", error.message);
                paymentHistoryList.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-red-500">${error.message}</td></tr>`;
            });
        }
        
        function closeHistoryModal() {
            if (milkLogUnsubscriber) milkLogUnsubscriber();
            if (paymentLogUnsubscriber) paymentLogUnsubscriber();
            milkLogUnsubscriber = null;
            paymentLogUnsubscriber = null;
            
            historyModalBackdrop.classList.remove('active');
            historyModalContent.classList.remove('active');
        }
        
        closeHistoryBtn.addEventListener('click', closeHistoryModal);
        historyModalBackdrop.addEventListener('click', closeHistoryModal);


        // ✨ ===== New: 14.5 CHATBOT FUNCTIONS =====
        function setupChatbot() {
            chatbotFabBtn.addEventListener('click', openChatModal);
            closeChatBtn.addEventListener('click', closeChatModal);
            chatModalBackdrop.addEventListener('click', closeChatModal);
            
            chatForm.addEventListener('submit', handleChatSubmit);
        }

        function openChatModal() {
            chatModalBackdrop.classList.add('active');
            chatModalContent.classList.add('active');
            chatInput.focus();
        }

        function closeChatModal() {
            chatModalBackdrop.classList.remove('active');
            chatModalContent.classList.remove('active');
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const prompt = chatInput.value.trim();
            if (prompt === "") return;

            appendChatMessage('user', prompt);
            chatInput.value = '';
            chatLoading.style.display = 'block';

            try {
                const systemPrompt = t("geminiChatSystemPrompt");
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const responseText = await callGeminiApi(payload);
                appendChatMessage('gemini', responseText);

            } catch (error) {
                console.error("Chatbot Error:", error);
                appendChatMessage('gemini', t("geminiError") + error.message);
            } finally {
                chatLoading.style.display = 'none';
            }
        }

        function appendChatMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message chat-message-${sender}`;
            messageDiv.textContent = text;
            chatHistory.appendChild(messageDiv);
            // Scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }


        // ===== 15. FAT LOG & CHART =====
        const addFatLogForm = document.getElementById('add-fat-log-form');
        const fatLogList = document.getElementById('fat-log-list');

        addFatLogForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('fat-date').value;
            const fatValue = parseFloat(document.getElementById('fat-value').value);

            if (!date || isNaN(fatValue) || fatValue <= 0) {
                showToast("allFieldsRequired", true);
                return;
            }

            try {
                await addDoc(fatLogCollectionRef, {
                    date,
                    fatValue,
                    createdAt: Timestamp.now(),
                    adminId: currentAdminId // Add adminId
                });
                showToast("fatEntryAdded");
                addFatLogForm.reset();
                document.getElementById('fat-date').value = getTodayDateString(); // Reset date
            } catch (error) {
                showToast(t("error") + error.message, true);
            }
        });

        // New: Event listener for deleting fat logs
        fatLogList.addEventListener('click', async (e) => {
            const target = e.target.closest('.btn-delete-fat');
            if (!target) return;
            
            const fatLogId = target.dataset.id;
            
            // Use new confirm modal
            showConfirmModal("confirmDeleteFat", "confirmDeleteFat", async () => {
                try {
                    await deleteDoc(doc(fatLogCollectionRef, fatLogId));
                    showToast("fatLogDeleted");
                } catch (error) {
                    showToast(t("error") + error.message, true);
                }
            });
        });

        function listenToFatLog() {
            if (!fatLogCollectionRef) return;
            // ✨ FIX: Remove orderBy, add client-side sort
            const q = query(fatLogCollectionRef);
            onSnapshot(q, (snapshot) => {
                allFatData = []; // Reset cache
                snapshot.forEach(doc => {
                    allFatData.push({ id: doc.id, ...doc.data() });
                });
                // ✨ FIX: Sort in JS
                allFatData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                renderFatLogList(allFatData);
                updateDashboardFat(allFatData);
                // Update chart with the currently selected filter
                const activeFilter = document.querySelector('.fat-filter-btn.active');
                const days = activeFilter ? parseInt(activeFilter.dataset.days) : 7;
                updateFatChart(days);
            }, (error) => {
                // This is where the index error happens
                console.error("Error listening to fat logs:", error);
                if (error.code === 'failed-precondition') {
                    console.error(`FIREBASE INDEX ERROR: The 'fatLogs' query requires an index on (adminId, date). Please create it in your Firebase console. ${error.message}`);
                    fatLogList.innerHTML = `<tr><td colspan="3" class="text-center p-6 text-red-500 dark:text-red-300"><b>Data Error:</b> Required Firebase index is missing. See console for link.</td></tr>`;
                }
            });
        }

        function renderFatLogList(logs) {
            fatLogList.innerHTML = '';
            if (logs.length === 0) {
                fatLogList.innerHTML = `<tr><td colspan="3" class="text-center p-6 text-gray-500 dark:text-gray-400">${t("noFatLog")}</td></tr>`;
                return;
            }
            logs.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${log.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${log.fatValue.toFixed(1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-id="${log.id}" class="btn-delete-fat px-3 py-1 bg-red-100 text-red-700 rounded-md hover:bg-red-200 dark:bg-red-800 dark:text-red-200 dark:hover:bg-red-700 transition-colors" title="${t('delete')}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                fatLogList.appendChild(row);
            });
        }

        function updateDashboardFat(logs) {
            const today = getTodayDateString();
            const todayLog = logs.find(log => log.date === today);
            const statTodayFat = document.getElementById('stat-today-fat');
            
            if (todayLog) {
                statTodayFat.textContent = todayLog.fatValue.toFixed(1);
            } else {
                statTodayFat.textContent = '--';
            }
        }

        function updateFatChart(days) {
            let filteredLogs = [];
            if (days > 0) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                const cutoffString = cutoffDate.toISOString().split('T')[0];
                filteredLogs = allFatData.filter(log => log.date >= cutoffString);
            } else {
                filteredLogs = [...allFatData]; // All time
            }

            // Sort ascending for chart
            filteredLogs.sort((a, b) => new Date(a.date) - new Date(b.date));

            const labels = filteredLogs.map(log => new Date(log.date).toLocaleDateString(currentLanguage === 'mr' ? 'mr-IN' : 'en-IN', { day: '2-digit', month: 'short' }));
            const data = filteredLogs.map(log => log.fatValue);

            const ctx = document.getElementById('fat-chart').getContext('2d');
            
            // ✨ New: Dark mode colors
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
            const labelColor = isDark ? '#d1d5db' : '#374151';
            const pointColor = isDark ? '#60a5fa' : '#3b82f6';
            const borderColor = isDark ? '#60a5fa' : '#3b82f6';
            const bgColor = isDark ? 'rgba(96, 165, 250, 0.2)' : 'rgba(59, 130, 246, 0.1)';

            if (fatChartInstance) {
                fatChartInstance.destroy();
            }

            fatChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: t('fatValue'),
                        data: data,
                        borderColor: borderColor,
                        backgroundColor: bgColor,
                        fill: true,
                        tension: 0.1,
                        borderWidth: 2,
                        pointBackgroundColor: pointColor
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                color: labelColor,
                                callback: function(value) {
                                    return value.toFixed(1) // Show one decimal place on Y-axis
                                }
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: {
                                color: labelColor,
                                maxRotation: 0,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10 // Limit ticks on x-axis for readability
                            },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(1)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function setupChartFilterButtons() {
            document.querySelectorAll('.fat-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const days = parseInt(btn.dataset.days);
                    updateFatChart(days);
                    
                    document.querySelectorAll('.fat-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
        }


        // ===== 16. INITIAL LOAD =====
        // Moved to authStateChanged
        // const savedLang = localStorage.getItem('dairyLang') || 'en';
        // setLanguage(savedLang);

    </script>
</body>
</html>
